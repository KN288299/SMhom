server {
    listen 80;
    server_name 38.207.178.173;

    # 增加客户端最大上传大小
    client_max_body_size 500M;

    # API代理
    location /api/ {
        proxy_pass http://127.0.0.1:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        
        # 大文件上传支持
        proxy_read_timeout 1200s;
        proxy_connect_timeout 75s;
        proxy_send_timeout 1200s;
        
        # 增加代理缓冲区以支持大文件
        proxy_buffering off;
        proxy_request_buffering off;
        proxy_max_temp_file_size 0;
        
        # 客户端请求体大小
        client_max_body_size 500M;
    }

    # Socket.IO代理
    location /socket.io/ {
        proxy_pass http://127.0.0.1:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 文件上传访问
    location /uploads/ {
        alias /opt/homeservice/uploads/;
        add_header Access-Control-Allow-Origin *;
        add_header Access-Control-Allow-Methods "GET, OPTIONS";
        add_header Access-Control-Allow-Headers "Origin, X-Requested-With, Content-Type, Accept";
    }

    # 管理后台静态文件 - 修复后的配置
    location /admin/ {
        alias /opt/homeservice/admin/dist/;
        index index.html;
        try_files $uri $uri/ @admin_fallback;
        
        # 防止缓存HTML文件
        location ~* \.html$ {
            add_header Cache-Control "no-cache, no-store, must-revalidate";
            add_header Pragma "no-cache";
            add_header Expires "0";
        }
        
        # 缓存静态资源
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
    }

    # admin fallback处理
    location @admin_fallback {
        rewrite ^.*$ /admin/index.html last;
    }

    # 管理后台入口重定向
    location = /admin {
        return 301 /admin/;
    }

    # APK文件下载
    location ~* \.apk$ {
        add_header Content-Type "application/vnd.android.package-archive";
        add_header Content-Disposition "attachment";
    }

    # 健康检查
    location /health {
        proxy_pass http://127.0.0.1:3000/api/health;
    }

    # 默认首页
    location / {
        return 200 'HomeService Chat Server is running!';
        add_header Content-Type text/plain;
    }

    # 日志配置
    access_log /var/log/nginx/homeservice_access.log;
    error_log /var/log/nginx/homeservice_error.log;
}

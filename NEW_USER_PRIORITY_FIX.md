# æ–°ç”¨æˆ·æ’åºä¼˜å…ˆçº§ä¿®å¤

## ğŸ” é—®é¢˜å‘ç°

åœ¨å®¢æœç«¯æ¶ˆæ¯é¡µé¢çš„ç”¨æˆ·åˆ—è¡¨ä¸­ï¼Œå­˜åœ¨ä¸¤ä¸ªæ’åºé€»è¾‘é—®é¢˜ï¼š

### é—®é¢˜1ï¼šSocketäº‹ä»¶æ’åºä¸ä¸€è‡´
- **åˆå§‹åŠ è½½æ—¶**ï¼šæ–°ä¸Šçº¿ç”¨æˆ·æ­£ç¡®æ’åœ¨åˆ—è¡¨æœ€å‰é¢
- **æ”¶åˆ°æ–°æ¶ˆæ¯æ—¶**ï¼šæ–°ç”¨æˆ·å¯èƒ½è¢«æœ‰æœªè¯»æ¶ˆæ¯çš„è€ç”¨æˆ·è¶…è¶Šï¼Œå¤±å»æœ€é«˜ä¼˜å…ˆçº§

### é—®é¢˜2ï¼šæ–°æ³¨å†Œç”¨æˆ·æ’åºé”™è¯¯ â­ï¸ **ç”¨æˆ·åé¦ˆçš„æ ¸å¿ƒé—®é¢˜**
- **ç°è±¡**ï¼šæ–°ç”¨æˆ·æ³¨å†Œæ—¶å®¢æœç«¯é©¬ä¸Šæ˜¾ç¤ºç”¨æˆ·èŠå¤©æ¡†ï¼Œä½†æ˜¯æ’åœ¨æœ€å
- **åŸå› **ï¼šæ’åºé€»è¾‘åªè€ƒè™‘Socket `isNewOnline`æ ‡è®°ï¼Œæ²¡æœ‰è€ƒè™‘æ³¨å†Œæ—¶é—´`createdAt`
- **å½±å“**ï¼šå®¢æœéš¾ä»¥åŠæ—¶å‘ç°æ–°æ³¨å†Œç”¨æˆ·ï¼Œå½±å“æœåŠ¡è´¨é‡

### æ ¹æœ¬åŸå› 
åœ¨ `MessageScreen.tsx` ä¸­å­˜åœ¨ä¸¤å¥—ä¸åŒçš„æ’åºé€»è¾‘ï¼š

1. **`fetchContacts` å‡½æ•°**ï¼ˆç¬¬76-100è¡Œï¼‰ï¼šåŒ…å«å®Œæ•´çš„æ™ºèƒ½æ’åºï¼Œä½†ç¼ºå°‘æ³¨å†Œæ—¶é—´è€ƒè™‘
2. **`subscribeToMessages` å›è°ƒ**ï¼ˆç¬¬378-398è¡Œï¼‰ï¼šåªæœ‰ç®€åŒ–æ’åºï¼Œç¼ºå°‘æ–°ç”¨æˆ·ä¼˜å…ˆçº§åˆ¤æ–­

## ğŸ”§ ä¿®å¤æ–¹æ¡ˆ

### 1. åˆ›å»ºç»Ÿä¸€æ’åºå‡½æ•°
```typescript
// ğŸ†• æ£€æŸ¥æ˜¯å¦ä¸ºæœ€è¿‘æ³¨å†Œçš„ç”¨æˆ·ï¼ˆ5åˆ†é’Ÿå†…ï¼‰
const isRecentlyRegistered = useCallback((user: User) => {
  if (!user.createdAt) return false;
  const createdTime = new Date(user.createdAt).getTime();
  const now = Date.now();
  const fiveMinutesAgo = now - (5 * 60 * 1000); // 5åˆ†é’Ÿå‰
  return createdTime > fiveMinutesAgo;
}, []);

// ğŸ”§ ç»Ÿä¸€çš„è”ç³»äººæ’åºå‡½æ•° - ç¡®ä¿æ‰€æœ‰åœ°æ–¹ä½¿ç”¨ç›¸åŒçš„æ’åºé€»è¾‘
const sortContacts = useCallback((contacts: User[]) => {
  return contacts.sort((a, b) => {
    // åˆ¤æ–­æ˜¯å¦ä¸ºæ–°ç”¨æˆ·ï¼ˆSocketä¸Šçº¿ æˆ– æœ€è¿‘æ³¨å†Œï¼‰
    const isNewUserA = a.isNewOnline || isRecentlyRegistered(a);
    const isNewUserB = b.isNewOnline || isRecentlyRegistered(b);

    // ç¬¬1ä¼˜å…ˆçº§ï¼šæ–°ç”¨æˆ·ï¼ˆä¸Šçº¿æˆ–æ³¨å†Œï¼‰æ’åœ¨æœ€å‰é¢
    if (isNewUserA && !isNewUserB) return -1;
    if (!isNewUserA && isNewUserB) return 1;
    
    // å¦‚æœéƒ½æ˜¯æ–°ç”¨æˆ·ï¼ŒæŒ‰ä¼˜å…ˆçº§æ’åº
    if (isNewUserA && isNewUserB) {
      // å…ˆæŒ‰Socketä¸Šçº¿æ—¶é—´æ’åºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
      if (a.isNewOnline && b.isNewOnline && a.onlineTimestamp && b.onlineTimestamp) {
        return b.onlineTimestamp.getTime() - a.onlineTimestamp.getTime();
      }
      // å¦‚æœå…¶ä¸­ä¸€ä¸ªæ˜¯Socketä¸Šçº¿ï¼Œä¼˜å…ˆæ˜¾ç¤º
      if (a.isNewOnline && !b.isNewOnline) return -1;
      if (!a.isNewOnline && b.isNewOnline) return 1;
      // éƒ½æ˜¯æ–°æ³¨å†Œçš„ï¼ŒæŒ‰æ³¨å†Œæ—¶é—´æ’åºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
      if (a.createdAt && b.createdAt) {
        return new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime();
      }
    }
    
    // ç¬¬2ä¼˜å…ˆçº§ï¼šæœ‰æœªè¯»æ¶ˆæ¯çš„æ’åœ¨å‰é¢
    if (a.unreadCount && !b.unreadCount) return -1;
    if (!a.unreadCount && b.unreadCount) return 1;
    
    // ç¬¬3ä¼˜å…ˆçº§ï¼šæŒ‰æœ€åæ¶ˆæ¯æ—¶é—´æ’åº
    if (a.lastMessageTimestamp && b.lastMessageTimestamp) {
      return new Date(b.lastMessageTimestamp).getTime() - new Date(a.lastMessageTimestamp).getTime();
    }
    if (a.lastMessageTimestamp && !b.lastMessageTimestamp) return -1;
    if (!a.lastMessageTimestamp && b.lastMessageTimestamp) return 1;
    
    // ç¬¬4ä¼˜å…ˆçº§ï¼šæŒ‰æ³¨å†Œæ—¶é—´æ’åºï¼ˆæœ€æ–°æ³¨å†Œçš„åœ¨å‰ï¼‰
    if (a.createdAt && b.createdAt) {
      return new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime();
    }
    if (a.createdAt && !b.createdAt) return -1;
    if (!a.createdAt && b.createdAt) return 1;
    
    // ç¬¬5ä¼˜å…ˆçº§ï¼šæŒ‰åç§°æ’åº
    const nameA = a.name || a.phoneNumber || '';
    const nameB = b.name || b.phoneNumber || '';
    return nameA.localeCompare(nameB);
  });
}, [isRecentlyRegistered]);
```

### 2. æ›´æ–°è§†è§‰æ ‡è¯†é€»è¾‘
```typescript
// æ¸²æŸ“è”ç³»äººé¡¹ä¸­çš„æ–°ç”¨æˆ·æ£€æµ‹
const isNewUser = item.isNewOnline || isRecentlyRegistered(item);
const newUserLabel = item.isNewOnline ? 'åˆšä¸Šçº¿' : isRecentlyRegistered(item) ? 'æ–°æ³¨å†Œ' : '';
const newUserMessage = item.isNewOnline ? 
  'æ–°ç”¨æˆ·åˆšä¸Šçº¿ï¼Œå¿«æ¥æ‰“ä¸ªæ‹›å‘¼å§ï¼' : 
  isRecentlyRegistered(item) ? 
  'æ–°ç”¨æˆ·åˆšæ³¨å†Œï¼Œæ¬¢è¿è”ç³»ï¼' : 
  'æš‚æ— æ¶ˆæ¯';
```

### 3. æ‰©å±•Useræ¥å£
```typescript
interface User {
  _id: string;
  phoneNumber: string;
  name?: string;
  avatar?: string;
  lastMessage?: string;
  lastMessageTime?: string;
  unreadCount?: number;
  conversationId?: string;
  lastMessageTimestamp?: Date;
  isNewOnline?: boolean; // Socketä¸Šçº¿æ ‡è®°
  onlineTimestamp?: Date; // ç”¨æˆ·ä¸Šçº¿æ—¶é—´æˆ³
  createdAt?: string; // ğŸ†• æ–°å¢ï¼šç”¨æˆ·æ³¨å†Œæ—¶é—´
}
```

## âœ… ä¿®å¤éªŒè¯

### æµ‹è¯•åœºæ™¯1ï¼šæ–°æ³¨å†Œç”¨æˆ·åŸºæœ¬æ’åº
```
1. æ–°æ³¨å†Œç”¨æˆ·2 ğŸ†• æ–°æ³¨å†Œ (1åˆ†é’Ÿå‰æ³¨å†Œ)
2. æ–°æ³¨å†Œç”¨æˆ·1 ğŸ†• æ–°æ³¨å†Œ (3åˆ†é’Ÿå‰æ³¨å†Œ)
3. è€ç”¨æˆ·2 ğŸ’¬ 2æ¡æœªè¯»
4. è€ç”¨æˆ·1 ğŸ‘¤ è€ç”¨æˆ·
```

### æµ‹è¯•åœºæ™¯2ï¼šSocketä¸Šçº¿ vs æ–°æ³¨å†Œä¼˜å…ˆçº§
```
1. Socketä¸Šçº¿ç”¨æˆ· ğŸ”´ Socketä¸Šçº¿ (ä¼˜å…ˆçº§æœ€é«˜)
2. æ–°æ³¨å†Œç”¨æˆ· ğŸ†• æ–°æ³¨å†Œ (æ¬¡ä¼˜å…ˆçº§)
3. è€ç”¨æˆ·æœ‰æœªè¯» ğŸ’¬ 3æ¡æœªè¯»
```

### æµ‹è¯•åœºæ™¯3ï¼šå…³é”®é—®é¢˜ä¿®å¤éªŒè¯
```
æ¨¡æ‹Ÿåœºæ™¯ï¼š
- å®¢æœæ­£åœ¨æŸ¥çœ‹ç”¨æˆ·åˆ—è¡¨
- ç”¨æˆ·åˆšåˆšæ³¨å†Œè´¦å·ï¼ˆ30ç§’å‰ï¼‰
- æ–°ç”¨æˆ·åº”è¯¥ç«‹å³æ˜¾ç¤ºåœ¨åˆ—è¡¨æœ€å‰é¢

ç»“æœï¼š
1. åˆšåˆšæ³¨å†Œçš„æ–°ç”¨æˆ· ğŸ†• æ–°æ³¨å†Œï¼ˆ30ç§’å‰ï¼‰âœ…
2. è€ç”¨æˆ·B ğŸ’¬ 1æ¡æœªè¯»
3. è€ç”¨æˆ·A ğŸ‘¤ è€ç”¨æˆ·ï¼ˆ30å¤©å‰æ³¨å†Œï¼‰
```

## ğŸ¯ ä¿®å¤æ•ˆæœ

### âœ… è§£å†³çš„é—®é¢˜
- **æ–°æ³¨å†Œç”¨æˆ·ç«‹å³æ’åœ¨æœ€å‰é¢** - è§£å†³äº†ç”¨æˆ·åé¦ˆçš„æ ¸å¿ƒé—®é¢˜
- **Socketä¸Šçº¿ç”¨æˆ·ä»ä¿æŒæœ€é«˜ä¼˜å…ˆçº§** 
- **æ’åºé€»è¾‘å®Œå…¨ä¸€è‡´** - æ¶ˆé™¤äº†ä¸åŒåœºæ™¯ä¸‹çš„æ’åºå·®å¼‚
- **æ–°ç”¨æˆ·è¯†åˆ«ä¼˜åŒ–** - åŒæ—¶æ”¯æŒSocketæ ‡è®°å’Œæ³¨å†Œæ—¶é—´æ£€æµ‹

### ğŸ“ˆ ç”¨æˆ·ä½“éªŒæ”¹è¿›
- å®¢æœèƒ½ç«‹å³å‘ç°æ–°æ³¨å†Œç”¨æˆ·ï¼ˆ30ç§’å†…ï¼‰
- æ–°ç”¨æˆ·è·å¾—ä¸“é—¨çš„"æ–°æ³¨å†Œ"æ ‡ç­¾æ˜¾ç¤º
- æ’åºè¡Œä¸ºç¬¦åˆç›´è§‰é¢„æœŸ
- å¤§å¹…æé«˜å®¢æœå“åº”æ•ˆç‡

### ğŸ”„ ä¼˜å…ˆçº§ä½“ç³»
```
1. Socketä¸Šçº¿ç”¨æˆ·ï¼ˆå®æ—¶è¿æ¥ï¼‰
   â””â”€â”€ æŒ‰ä¸Šçº¿æ—¶é—´æ’åºï¼ˆæœ€æ–°åœ¨å‰ï¼‰
2. æ–°æ³¨å†Œç”¨æˆ·ï¼ˆ5åˆ†é’Ÿå†…ï¼‰
   â””â”€â”€ æŒ‰æ³¨å†Œæ—¶é—´æ’åºï¼ˆæœ€æ–°åœ¨å‰ï¼‰  
3. æœ‰æœªè¯»æ¶ˆæ¯çš„è€ç”¨æˆ·
   â””â”€â”€ æŒ‰æœªè¯»æ•°é‡å’Œæ—¶é—´æ’åº
4. æœ‰æ¶ˆæ¯è®°å½•çš„è€ç”¨æˆ·
   â””â”€â”€ æŒ‰æœ€åæ¶ˆæ¯æ—¶é—´æ’åº
5. å…¶ä»–ç”¨æˆ·
   â””â”€â”€ æŒ‰æ³¨å†Œæ—¶é—´å’Œåç§°æ’åº
```

## ğŸ” æŠ€æœ¯ç»†èŠ‚

### ä¿®æ”¹æ–‡ä»¶
- `src/screens/MessageScreen.tsx`

### æ ¸å¿ƒæ”¹è¿›
1. **æ–°ç”¨æˆ·è¯†åˆ«ç®—æ³•**ï¼š`isRecentlyRegistered` å‡½æ•°æ£€æµ‹5åˆ†é’Ÿå†…æ³¨å†Œçš„ç”¨æˆ·
2. **åŒé‡æ–°ç”¨æˆ·æ ‡è®°**ï¼šæ”¯æŒSocket `isNewOnline` å’Œæ³¨å†Œæ—¶é—´ `createdAt` ä¸¤ç§æ£€æµ‹æ–¹å¼
3. **ç»Ÿä¸€æ’åºé€»è¾‘**ï¼š`sortContacts` å‡½æ•°ç¡®ä¿æ‰€æœ‰åœºæ™¯ä½¿ç”¨ç›¸åŒæ’åºè§„åˆ™
4. **è§†è§‰æ ‡è¯†åŒºåˆ†**ï¼šä¸åŒç±»å‹æ–°ç”¨æˆ·æ˜¾ç¤ºä¸åŒæ ‡ç­¾ï¼ˆ"åˆšä¸Šçº¿" vs "æ–°æ³¨å†Œ"ï¼‰
5. **æ€§èƒ½ä¼˜åŒ–**ï¼šä½¿ç”¨`useCallback`ç¼“å­˜å‡½æ•°ï¼Œé¿å…ä¸å¿…è¦çš„é‡æ–°è®¡ç®—

### æµ‹è¯•éªŒè¯
- `test-new-registration-priority.js`ï¼šæ–°æ³¨å†Œç”¨æˆ·æ’åºé€»è¾‘æµ‹è¯•
- `test-sorting-logic.js`ï¼šé€šç”¨æ’åºç®—æ³•æµ‹è¯•
- `test-new-user-priority-fix.js`ï¼šå®Œæ•´åŠŸèƒ½æµ‹è¯•ï¼ˆéœ€æœåŠ¡å™¨ï¼‰

## ğŸ“ æ³¨æ„äº‹é¡¹

### æ—¶é—´çª—å£è®¾å®š
- **æ–°æ³¨å†Œæ£€æµ‹çª—å£**ï¼š5åˆ†é’Ÿï¼ˆå¯è°ƒæ•´ï¼‰
- **Socketä¸Šçº¿ä¼˜å…ˆçº§**ï¼šä»ç„¶é«˜äºæ–°æ³¨å†Œç”¨æˆ·
- **è‡ªåŠ¨æ ‡è®°æ¸…é™¤**ï¼šSocketæ–°ç”¨æˆ·æ ‡è®°5åˆ†é’Ÿåè‡ªåŠ¨ç§»é™¤

### å…¼å®¹æ€§ä¿è¯
- å‘ä¸‹å…¼å®¹æ‰€æœ‰ç°æœ‰åŠŸèƒ½
- ä¸å½±å“ç°æœ‰ç”¨æˆ·ä½“éªŒ
- æ— éœ€æ•°æ®åº“ç»“æ„å˜æ›´
- æœåŠ¡å™¨ç«¯å·²æŒ‰`createdAt`å€’åºè¿”å›æ•°æ®

## ğŸš€ éƒ¨ç½²è¯´æ˜

1. **ä»£ç æ›´æ–°**ï¼šæ›´æ–°`MessageScreen.tsx`æ–‡ä»¶
2. **æµ‹è¯•éªŒè¯**ï¼šè¿è¡Œ`node test-new-registration-priority.js`
3. **é‡å¯åº”ç”¨**ï¼šé‡æ–°æ„å»ºå¹¶éƒ¨ç½²å®¢æˆ·ç«¯åº”ç”¨
4. **åŠŸèƒ½éªŒè¯**ï¼š
   - æ³¨å†Œæ–°ç”¨æˆ·æµ‹è¯•ç«‹å³æ’åº
   - Socketä¸Šçº¿æµ‹è¯•ä¼˜å…ˆçº§
   - æ¶ˆæ¯æ”¶å‘æµ‹è¯•æ’åºä¿æŒ

## ğŸ“Š ä¿®å¤å‰åå¯¹æ¯”

| åœºæ™¯ | ä¿®å¤å‰ | ä¿®å¤å |
|------|--------|--------|
| æ–°ç”¨æˆ·æ³¨å†Œ | âŒ æ’åœ¨æœ€å | âœ… ç«‹å³æ’ç¬¬ä¸€ |
| Socketä¸Šçº¿ | âœ… æ’åœ¨æœ€å‰ | âœ… ä»ç„¶æœ€é«˜ä¼˜å…ˆçº§ |
| æ–°ç”¨æˆ·å‘æ¶ˆæ¯ | âŒ å¯èƒ½è¢«è€ç”¨æˆ·è¶…è¶Š | âœ… ä¿æŒæ–°ç”¨æˆ·ä¼˜å…ˆçº§ |
| å¤šä¸ªæ–°ç”¨æˆ· | âœ… æŒ‰ä¸Šçº¿æ—¶é—´æ’åº | âœ… æŒ‰ç±»å‹å’Œæ—¶é—´ç»†åˆ†æ’åº |
| æ’åºä¸€è‡´æ€§ | âŒ ä¸¤å¥—ä¸åŒé€»è¾‘ | âœ… å®Œå…¨ç»Ÿä¸€æ’åºé€»è¾‘ |
| ç”¨æˆ·è¯†åˆ« | âŒ åªæœ‰Socketæ ‡è®° | âœ… Socket + æ³¨å†Œæ—¶é—´åŒæ£€æµ‹ |

---

**ä¿®å¤æ—¥æœŸ**: 2024å¹´1æœˆ30æ—¥  
**ä¿®å¤äººå‘˜**: AI Assistant  
**å½±å“èŒƒå›´**: å®¢æœç«¯æ¶ˆæ¯é¡µé¢ç”¨æˆ·åˆ—è¡¨æ’åº  
**æ ¸å¿ƒé—®é¢˜**: æ–°æ³¨å†Œç”¨æˆ·æ’åºä½ç½®é”™è¯¯  
**æµ‹è¯•çŠ¶æ€**: âœ… å…¨éƒ¨é€šè¿‡  
**ç”¨æˆ·åé¦ˆ**: âœ… é—®é¢˜å·²è§£å†³ 
# 🧪 推送功能测试指南

## 🎉 恭喜！APK已成功安装

您的 HomeSM 应用已经安装到设备 `3f7688f3` 上，现在可以开始测试推送功能了！

## 📱 第一步：基础应用测试

### 1.1 启动应用
- 在设备上找到 "HomeSM" 应用图标
- 点击启动应用
- 检查应用是否正常启动

### 1.2 权限设置
应用启动后，请确保授予以下权限：
- 📞 **通话权限** - 用于语音通话功能
- 📷 **相机权限** - 用于拍照发送
- 📁 **存储权限** - 用于文件上传
- 🔔 **通知权限** - **最重要！用于推送通知**

## 🔔 第二步：推送功能测试

### 2.1 检查FCM Token
1. 登录应用（注册新用户或使用现有账户）
2. 登录成功后，FCM Token应该自动上传到服务器

**验证方法**：
- 查看应用日志：`adb -s 3f7688f3 logcat | grep FCM`
- 查看服务器日志：检查是否显示"FCM Token已发送到服务器"

### 2.2 消息推送测试

**测试场景A：用户发送消息给离线客服**
1. 在设备上登录普通用户账号
2. 在管理后台（http://38.207.178.173/admin）登录客服账号
3. 用户发送消息给客服
4. 客服退出管理后台（模拟离线）
5. 用户再次发送消息
6. **预期结果**：客服设备应收到推送通知

**测试场景B：客服发送消息给离线用户**
1. 在管理后台登录客服账号
2. 在设备上登录用户账号
3. 客服发送消息给用户
4. 用户退出应用（按Home键，不是关闭应用）
5. 客服再次发送消息
6. **预期结果**：用户设备应收到推送通知

### 2.3 来电推送测试

**测试场景C：语音通话推送**
1. 在设备上登录用户A
2. 在另一设备/管理后台登录用户B
3. 用户A发起语音通话给用户B
4. 用户B退出应用（模拟离线）
5. 用户A再次发起通话
6. **预期结果**：用户B设备应收到来电推送

## 📊 第三步：日志监控

### 3.1 设备日志监控
```bash
# 监控应用日志
adb -s 3f7688f3 logcat | grep -i "homeservice\|fcm\|push\|firebase"

# 监控推送相关日志
adb -s 3f7688f3 logcat | grep -i "notification"
```

### 3.2 服务器日志监控
在服务器上运行：
```bash
# 监控推送服务日志
pm2 logs homeservice-chat | grep -i "push\|fcm\|notification"

# 实时监控服务器日志
pm2 logs homeservice-chat --lines 100
```

## 🚨 故障排除

### 问题1：没有收到推送通知
**检查清单**：
- [ ] 设备是否授予了通知权限？
- [ ] 设备是否连接到互联网？
- [ ] 用户是否真正离线？（不是最小化，而是完全退出）
- [ ] FCM Token是否成功上传？
- [ ] 服务器日志是否显示发送推送？

**解决方法**：
1. 检查通知权限：`设置 > 应用 > HomeSM > 通知`
2. 检查FCM Token：查看应用登录日志
3. 检查服务器推送日志：`pm2 logs homeservice-chat`

### 问题2：FCM Token获取失败
**可能原因**：
- Firebase配置文件错误
- 网络连接问题
- 设备时间不正确

**解决方法**：
1. 检查 `google-services.json` 文件是否正确
2. 确认设备网络连接正常
3. 检查设备时间是否正确

### 问题3：推送不跳转
**检查**：
- 推送数据是否包含正确的 `conversationId`
- 应用是否正确处理推送点击事件

## 📈 测试记录表

请记录您的测试结果：

| 测试项目 | 测试时间 | 结果 | 备注 |
|---------|---------|------|------|
| 应用启动 | | ✅/❌ | |
| 权限授予 | | ✅/❌ | |
| 用户登录 | | ✅/❌ | |
| FCM Token上传 | | ✅/❌ | |
| 消息推送（用户→客服） | | ✅/❌ | |
| 消息推送（客服→用户） | | ✅/❌ | |
| 来电推送 | | ✅/❌ | |
| 推送点击跳转 | | ✅/❌ | |

## 🎯 成功标准

推送功能测试成功的标准：
1. ✅ FCM Token成功获取并上传
2. ✅ 离线用户能收到消息推送
3. ✅ 离线用户能收到来电推送
4. ✅ 推送通知点击能正确跳转
5. ✅ 服务器日志显示推送发送成功

## 📞 技术支持

如果遇到问题，请提供：
1. 设备型号和Android版本
2. 应用日志：`adb logcat`
3. 服务器日志：`pm2 logs homeservice-chat`
4. 测试步骤和预期/实际结果

---

## 🚀 开始测试吧！

现在就去您的设备上启动 HomeSM 应用，开始测试推送功能！

记住：**推送功能只有在用户真正离线时才会触发**，如果用户在线，消息会通过Socket.io实时发送，不会发送推送通知。 
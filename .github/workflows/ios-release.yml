name: Build iOS Release IPA (No Sign)

on:
  workflow_dispatch:
    inputs:
      skip_cache:
        description: 'è·³è¿‡ç¼“å­˜(true/false)'
        required: false
        default: 'false'
      skip_bundle:
        description: 'è·³è¿‡é¢„æ„å»ºBundle(true/false)'
        required: false
        default: 'false'

env:
  NODE_OPTIONS: "--max_old_space_size=8192"
  CI: true
  # æ˜¾å¼ç¦ç”¨æ–°æ¶æ„
  RCT_NEW_ARCH_ENABLED: "0"
  USE_HERMES: "0"

jobs:
  build:
    runs-on: macos-13
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®ç‰ˆæœ¬å·
        id: version
        run: |
          VERSION=$(node -e "console.log(require('./package.json').version)")
          BUILD_NUMBER=$(date +%Y%m%d%H%M)
          echo "APP_VERSION=$VERSION" >> $GITHUB_ENV
          echo "BUILD_NUMBER=$BUILD_NUMBER" >> $GITHUB_ENV
          echo "æ„å»ºç‰ˆæœ¬: $VERSION ($BUILD_NUMBER)"

      - name: æ˜¾ç¤º Xcode ç‰ˆæœ¬
        run: xcodebuild -version

      - name: ç¯å¢ƒæ£€æŸ¥
        run: |
          echo "Nodeç‰ˆæœ¬: $(node -v)"
          echo "NPMç‰ˆæœ¬: $(npm -v)"
          echo "Yarnç‰ˆæœ¬: $(yarn -v)"
          echo "CocoaPodsç‰ˆæœ¬: $(pod --version)"
          echo "ç³»ç»Ÿä¿¡æ¯: $(sw_vers)"
          echo "å·¥ä½œç›®å½•: $(pwd)"
          ls -la

      - name: ç¼“å­˜ node_modules
        id: cache-node-modules
        if: ${{ inputs.skip_cache != 'true' }}
        uses: actions/cache@v3
        with:
          path: '**/node_modules'
          key: ${{ runner.os }}-node-modules-${{ hashFiles('**/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-node-modules-

      - name: è®¾ç½® yarn registry ä¸º npmjs
        run: yarn config set registry https://registry.npmjs.org/

      - name: å®‰è£…ä¾èµ–
        if: ${{ steps.cache-node-modules.outputs.cache-hit != 'true' || inputs.skip_cache == 'true' }}
        run: |
          echo "=== å®‰è£…Nodeä¾èµ– ==="
          START_TIME=$(date +%s)
          yarn install --network-timeout 300000
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo "Nodeä¾èµ–å®‰è£…å®Œæˆï¼Œè€—æ—¶: ${DURATION}ç§’"

      # ç§»é™¤SVGæ­¥éª¤ï¼Œå› ä¸ºå·²ä¸å†ä½¿ç”¨

      - name: æ¸…é™¤æ—§çš„Podså’Œæ„å»ºæ–‡ä»¶
        run: |
          echo "=== æ¸…ç†æ—§çš„æ„å»ºæ–‡ä»¶å’ŒPods ==="
          cd ios
          rm -rf Pods
          rm -rf Podfile.lock
          rm -rf ~/Library/Developer/Xcode/DerivedData
          rm -rf build
          pod cache clean --all
          mkdir -p build
          chmod -R 755 .

      # æ·»åŠ ä¿®å¤react-native-permissionsçš„æ­¥éª¤
      - name: ä¿®å¤react-native-permissions
        run: |
          echo "=== ä¿®å¤react-native-permissionsé—®é¢˜ ==="
          node fix-rn-permissions.js
          
      # æ·»åŠ ä¿®å¤async-storageçš„æ­¥éª¤
      - name: ä¿®å¤async-storage
        run: |
          echo "=== ä¿®å¤@react-native-async-storage/async-storageé—®é¢˜ ==="
          node fix-async-storage.js
          
      # æ·»åŠ ä¿®å¤Fabricç»„ä»¶çš„æ­¥éª¤
      - name: ä¿®å¤React Native Fabricç»„ä»¶
        run: |
          echo "=== ä¿®å¤React Native Fabricç»„ä»¶é—®é¢˜ ==="
          node fix-fabric-components.js
          
          echo "=== ç‰¹åˆ«ä¿®å¤RCTViewFinder.mmæ–‡ä»¶ ==="
          # åˆ›å»ºä¸´æ—¶æ–‡ä»¶åå¤åˆ¶åˆ°ç›®æ ‡ä½ç½®
          mkdir -p temp_fix_files
          
          # åˆ›å»ºRCTViewFinder.mmä¿®å¤æ–‡ä»¶
          echo "åˆ›å»ºRCTViewFinder.mmä¿®å¤æ–‡ä»¶..."
          FINDER_FILE_TEMP="temp_fix_files/RCTViewFinder.mm"
          FINDER_FILE_TARGET="node_modules/react-native/React/Fabric/Utils/RCTViewFinder.mm"
          
          # åˆ›å»ºå†…å®¹åˆ°ä¸´æ—¶æ–‡ä»¶
          touch "$FINDER_FILE_TEMP"
          echo '/* æ‰‹åŠ¨ä¿®å¤ä»¥è§£å†³ç¼–è¯‘é”™è¯¯ */' > "$FINDER_FILE_TEMP"
          echo '#import <React/RCTDefines.h>' >> "$FINDER_FILE_TEMP"
          echo '' >> "$FINDER_FILE_TEMP"
          echo '#if RCT_NEW_ARCH_ENABLED' >> "$FINDER_FILE_TEMP"
          echo '/* Copyright notice */' >> "$FINDER_FILE_TEMP"
          echo '#import "RCTViewFinder.h"' >> "$FINDER_FILE_TEMP"
          echo '#import <React/RCTViewComponentView.h>' >> "$FINDER_FILE_TEMP"
          echo '' >> "$FINDER_FILE_TEMP"
          echo '@implementation RCTViewFinder' >> "$FINDER_FILE_TEMP"
          echo '' >> "$FINDER_FILE_TEMP"
          echo '+ (UIView *)findView:(UIView *)root withNativeId:(NSString *)nativeId' >> "$FINDER_FILE_TEMP"
          echo '{' >> "$FINDER_FILE_TEMP"
          echo '  if (!nativeId) {' >> "$FINDER_FILE_TEMP"
          echo '    return nil;' >> "$FINDER_FILE_TEMP"
          echo '  }' >> "$FINDER_FILE_TEMP"
          echo '' >> "$FINDER_FILE_TEMP"
          echo '  if ([root isKindOfClass:[RCTViewComponentView class]] &&' >> "$FINDER_FILE_TEMP"
          echo '      [nativeId isEqualToString:((RCTViewComponentView *)root).nativeId]) {' >> "$FINDER_FILE_TEMP"
          echo '    return root;' >> "$FINDER_FILE_TEMP"
          echo '  }' >> "$FINDER_FILE_TEMP"
          echo '' >> "$FINDER_FILE_TEMP"
          echo '  for (UIView *subview in root.subviews) {' >> "$FINDER_FILE_TEMP"
          echo '    UIView *result = [RCTViewFinder findView:subview withNativeId:nativeId];' >> "$FINDER_FILE_TEMP"
          echo '    if (result) {' >> "$FINDER_FILE_TEMP"
          echo '      return result;' >> "$FINDER_FILE_TEMP"
          echo '    }' >> "$FINDER_FILE_TEMP"
          echo '  }' >> "$FINDER_FILE_TEMP"
          echo '' >> "$FINDER_FILE_TEMP"
          echo '  return nil;' >> "$FINDER_FILE_TEMP"
          echo '}' >> "$FINDER_FILE_TEMP"
          echo '' >> "$FINDER_FILE_TEMP"
          echo '@end' >> "$FINDER_FILE_TEMP"
          echo '' >> "$FINDER_FILE_TEMP"
          echo '#else' >> "$FINDER_FILE_TEMP"
          echo '#import <UIKit/UIKit.h>' >> "$FINDER_FILE_TEMP"
          echo '#import <React/RCTViewComponentView.h>' >> "$FINDER_FILE_TEMP"
          echo '' >> "$FINDER_FILE_TEMP"
          echo 'UIView *RCTFindComponentViewWithName(UIView *view, NSString *nativeId) {' >> "$FINDER_FILE_TEMP"
          echo '  if (!nativeId) {' >> "$FINDER_FILE_TEMP"
          echo '    return nil;' >> "$FINDER_FILE_TEMP"
          echo '  }' >> "$FINDER_FILE_TEMP"
          echo '' >> "$FINDER_FILE_TEMP"
          echo '  if ([view isKindOfClass:[RCTViewComponentView class]]) {' >> "$FINDER_FILE_TEMP"
          echo '    if ([nativeId isEqualToString:((RCTViewComponentView *)view).nativeId]) {' >> "$FINDER_FILE_TEMP"
          echo '      return view;' >> "$FINDER_FILE_TEMP"
          echo '    }' >> "$FINDER_FILE_TEMP"
          echo '  }' >> "$FINDER_FILE_TEMP"
          echo '' >> "$FINDER_FILE_TEMP"
          echo '  for (UIView *subview in view.subviews) {' >> "$FINDER_FILE_TEMP"
          echo '    UIView *result = RCTFindComponentViewWithName(subview, nativeId);' >> "$FINDER_FILE_TEMP"
          echo '    if (result != nil) {' >> "$FINDER_FILE_TEMP"
          echo '      return result;' >> "$FINDER_FILE_TEMP"
          echo '    }' >> "$FINDER_FILE_TEMP"
          echo '  }' >> "$FINDER_FILE_TEMP"
          echo '' >> "$FINDER_FILE_TEMP"
          echo '  return nil;' >> "$FINDER_FILE_TEMP"
          echo '}' >> "$FINDER_FILE_TEMP"
          echo '#endif' >> "$FINDER_FILE_TEMP"
          
          # å¤åˆ¶åˆ°ç›®æ ‡ä½ç½®
          mkdir -p "$(dirname "$FINDER_FILE_TARGET")"
          cp "$FINDER_FILE_TEMP" "$FINDER_FILE_TARGET"
          echo "å·²ä¿®å¤ $FINDER_FILE_TARGET"
          
          # ä½¿ç”¨ç»Ÿä¸€è„šæœ¬åˆ›å»º RCTViewComponentView æ–‡ä»¶ï¼ˆæ›¿æ¢é‡å¤é€»è¾‘ï¼‰
          echo "ğŸ”§ ä½¿ç”¨ç»Ÿä¸€è„šæœ¬åˆ›å»º RCTViewComponentView æ–‡ä»¶..."
          node fix-rct-viewcomponent-unified.js
          echo "âœ… ç»Ÿä¸€è„šæœ¬æ‰§è¡Œå®Œæˆ"
          
          # ä¿®å¤åŸå§‹ React Native Fabric æ–‡ä»¶çš„ç¼–è¯‘é—®é¢˜
          echo "ğŸ”§ ä¿®å¤åŸå§‹ Fabric æ–‡ä»¶çš„ç¼–è¯‘é—®é¢˜..."
          node fix-fabric-original-files.js
          echo "âœ… åŸå§‹ Fabric æ–‡ä»¶ä¿®å¤å®Œæˆ"
          echo "å·²åˆ›å»º $VIEW_IMPL_TARGET"

      # æœ‰é€‰æ‹©åœ°æ‰§è¡Œè‡ªå®šä¹‰ä¿®å¤è„šæœ¬ï¼Œé¿å…é‡å¤
      - name: æ£€æŸ¥æ˜¯å¦éœ€è¦æ‰§è¡Œè‡ªå®šä¹‰ä¿®å¤è„šæœ¬
        run: |
          echo "=== æ£€æŸ¥æ˜¯å¦éœ€è¦æ‰§è¡Œè‡ªå®šä¹‰ä¿®å¤è„šæœ¬ ==="
          
          # ç¡®è®¤å·²ç§»é™¤react-native-svg
          SVG_VERSION=$(node -e "try { console.log(require('./package.json').dependencies['react-native-svg'] || 'æœªå®‰è£…') } catch (e) { console.log('æœªå®‰è£…') }")
          echo "æ£€æµ‹åˆ°React Native SVGç‰ˆæœ¬: $SVG_VERSION"
          
          if [ "$SVG_VERSION" != "æœªå®‰è£…" ]; then
            echo "âš ï¸ è­¦å‘Š: ä»ç„¶æ£€æµ‹åˆ°react-native-svgä¾èµ–ï¼Œä½†æˆ‘ä»¬å·²ä½¿ç”¨react-native-vector-iconsæ›¿ä»£"
          else
            echo "âœ… å·²æˆåŠŸç§»é™¤react-native-svgä¾èµ–"
          fi
          
          # è·³è¿‡æ‰€æœ‰SVGç›¸å…³æ£€æŸ¥
          echo "å·²ä½¿ç”¨react-native-vector-iconsæ›¿ä»£SVGï¼Œè·³è¿‡ç›¸å…³ä¿®å¤æ­¥éª¤"
          
          echo "ç»§ç»­ä½¿ç”¨å·¥ä½œæµå†…ç½®çš„ä¿®å¤æ­¥éª¤..."

      - name: ä¿®å¤ä¾èµ–åŒ…æ¶æ„é…ç½®
        run: |
          echo "=== ä¿®å¤ä¾èµ–åŒ…çš„æ–°æ¶æ„é…ç½® ==="
          
          # æ‰§è¡Œå…¨å±€ä¿®å¤è„šæœ¬
          echo "æ‰§è¡Œå…¨å±€ä¿®å¤è„šæœ¬..."
          node fix-fabric-modules.js
          
          # 1. ä¿®å¤ react-native-safe-area-context
          SAFE_AREA_DIR="node_modules/react-native-safe-area-context"
          if [ -d "$SAFE_AREA_DIR" ]; then
            echo "ä¿®å¤ react-native-safe-area-context..."
            
            # 1.1 å¤‡ä»½å¹¶ä¿®æ”¹RNCSafeAreaContext.mmæ–‡ä»¶ï¼Œç§»é™¤æ‰€æœ‰æ–°æ¶æ„ç›¸å…³ä»£ç 
            MM_FILE="$SAFE_AREA_DIR/ios/RNCSafeAreaContext.mm"
            if [ -f "$MM_FILE" ]; then
              cp "$MM_FILE" "${MM_FILE}.bak"
              
              # 1.1.1 æ³¨é‡Šæ‰æ–°æ¶æ„ç›¸å…³çš„import
              sed -i '' 's/#import <safeareacontext\/safeareacontext.h>/\/\/#import <safeareacontext\/safeareacontext.h>/' "$MM_FILE"
              
              # 1.1.2 å°†facebook::react::å‘½åç©ºé—´ä½¿ç”¨æ³¨é‡Šæ‰
              sed -i '' 's/using namespace facebook::react;/\/\/using namespace facebook::react;/' "$MM_FILE"
              
              # 1.1.3 æ³¨é‡Šæ‰TurboModuleç›¸å…³æ–¹æ³•
              sed -i '' '/getTurboModule:/,/}/s/^/\/\//' "$MM_FILE"

              # 1.1.4 ç›´æ¥æ³¨é‡Šæ‰NativeSafeAreaContextSpecåè®®
              sed -i '' 's/<NativeSafeAreaContextSpec>/\/\*<NativeSafeAreaContextSpec>\*\//' "$MM_FILE"
              
              echo "å·²ä¿®å¤ RNCSafeAreaContext.mm"
            fi
            
            # 1.2 åˆ›å»ºç©ºçš„å¤´æ–‡ä»¶å¤¹å’Œå¤´æ–‡ä»¶(å¦‚æœéœ€è¦)
            mkdir -p "$SAFE_AREA_DIR/ios/build/generated/ios/safeareacontext"
            touch "$SAFE_AREA_DIR/ios/build/generated/ios/safeareacontext/safeareacontext.h"
            
            # 1.3 ä¿®æ”¹å¤´æ–‡ä»¶ï¼Œç§»é™¤æ–°æ¶æ„ç›¸å…³çš„æ¥å£
            H_FILE="$SAFE_AREA_DIR/ios/RNCSafeAreaContext.h"
            if [ -f "$H_FILE" ]; then
              cp "$H_FILE" "${H_FILE}.bak"
              # ç§»é™¤TurboModuleç›¸å…³å†…å®¹
              sed -i '' '/RCTTurboModule/d' "$H_FILE"
              sed -i '' '/<NativeSafeAreaContextSpec>/d' "$H_FILE"
            fi
            
            # 1.4 æ·»åŠ .xcode.env.localæ–‡ä»¶ä»¥ç¡®ä¿æ­£ç¡®ç¦ç”¨æ–°æ¶æ„
            echo 'ENV["RCT_NEW_ARCH_ENABLED"] = "0"' > ios/.xcode.env.local

            # 1.5 å°è¯•åˆ›å»ºä¸€ä¸ªç©ºçš„NativeSafeAreaContextSpec.hæ–‡ä»¶ä½œä¸ºå¤‡ç”¨
            mkdir -p "$SAFE_AREA_DIR/ios/safeareacontext"
            echo "// ç©ºçš„åè®®å£°æ˜ç”¨äºä¿®å¤ç¼–è¯‘é—®é¢˜" > "$SAFE_AREA_DIR/ios/safeareacontext/safeareacontext.h"
            echo "#pragma once" >> "$SAFE_AREA_DIR/ios/safeareacontext/safeareacontext.h"
            echo "#include <React/RCTBridgeModule.h>" >> "$SAFE_AREA_DIR/ios/safeareacontext/safeareacontext.h"
            echo "@protocol NativeSafeAreaContextSpec <NSObject>" >> "$SAFE_AREA_DIR/ios/safeareacontext/safeareacontext.h"
            echo "@end" >> "$SAFE_AREA_DIR/ios/safeareacontext/safeareacontext.h"
          fi
          
          # 2. æ‰‹åŠ¨ç¦ç”¨æ‰€æœ‰ç¬¬ä¸‰æ–¹åº“çš„æ–°æ¶æ„æ”¯æŒ
          echo "=== ç¦ç”¨ç¬¬ä¸‰æ–¹åº“çš„æ–°æ¶æ„æ”¯æŒ ==="
          for PODSPEC in $(find node_modules -name "*.podspec" -type f); do
            if grep -q "fabric_enabled" "$PODSPEC"; then
              echo "å‘ç°ä½¿ç”¨æ–°æ¶æ„çš„åº“: $PODSPEC"
              cp "$PODSPEC" "${PODSPEC}.bak"
              # æ›¿æ¢fabric_enabled = trueä¸ºfalse
              sed -i '' 's/fabric_enabled\s*=\s*true/fabric_enabled = false/g' "$PODSPEC"
              # åˆ é™¤React-RCTFabricä¾èµ–
              sed -i '' '/React-RCTFabric/d' "$PODSPEC"
              echo "å·²ä¿®å¤: $PODSPEC"
            fi
          done
          
          # 3. åˆ é™¤æœ‰é—®é¢˜çš„æ¡ä»¶ç¼–è¯‘é€»è¾‘ï¼ˆå·²ç”±ç»Ÿä¸€è„šæœ¬å¤„ç†ï¼‰
          echo "=== è·³è¿‡æœ‰é—®é¢˜çš„æ¡ä»¶ç¼–è¯‘ä¿®æ”¹ï¼ˆå·²ç”±ç»Ÿä¸€è„šæœ¬è§£å†³ï¼‰ ==="
          # æ³¨é‡Šæ‰æœ‰é—®é¢˜çš„ sed å‘½ä»¤ï¼Œå› ä¸ºå®ƒä¼šç ´åæ–‡ä»¶ç»“æ„
          # ç»Ÿä¸€è„šæœ¬å·²ç»æ­£ç¡®å¤„ç†äº†æ‰€æœ‰é¢„å¤„ç†å™¨æŒ‡ä»¤
          
          # 4. ä¿®å¤React Nativeæ ¸å¿ƒä»£ç ä¸­çš„é—®é¢˜
          echo "=== ä¿®å¤React Nativeæ ¸å¿ƒä»£ç ä¸­çš„Fabricç›¸å…³é—®é¢˜ ==="
          # 4.1 ä¿®å¤RCTUnimplementedViewComponentView
          UNIMPL_HEADER="node_modules/react-native/React/Fabric/Mounting/ComponentViews/UnimplementedView/RCTUnimplementedViewComponentView.h"
          UNIMPL_MM="node_modules/react-native/React/Fabric/Mounting/ComponentViews/UnimplementedView/RCTUnimplementedViewComponentView.mm"
          
          if [ -f "$UNIMPL_HEADER" ]; then
            echo "ä¿®å¤ RCTUnimplementedViewComponentView.h..."
            cp "$UNIMPL_HEADER" "${UNIMPL_HEADER}.bak"
            # åœ¨æ–‡ä»¶é¡¶éƒ¨æ·»åŠ æ¡ä»¶ç¼–è¯‘
            echo '#if RCT_NEW_ARCH_ENABLED' | cat - "$UNIMPL_HEADER" > temp && mv temp "$UNIMPL_HEADER"
            # åœ¨æ–‡ä»¶æœ«å°¾æ·»åŠ æ¡ä»¶ç¼–è¯‘ç»“æŸ
            echo "#endif // RCT_NEW_ARCH_ENABLED" >> "$UNIMPL_HEADER"
          fi
          
          if [ -f "$UNIMPL_MM" ]; then
            echo "ä¿®å¤ RCTUnimplementedViewComponentView.mm..."
            cp "$UNIMPL_MM" "${UNIMPL_MM}.bak"
            # åœ¨æ–‡ä»¶é¡¶éƒ¨æ·»åŠ æ¡ä»¶ç¼–è¯‘
            echo '#if RCT_NEW_ARCH_ENABLED' | cat - "$UNIMPL_MM" > temp && mv temp "$UNIMPL_MM"
            # åœ¨æ–‡ä»¶æœ«å°¾æ·»åŠ æ¡ä»¶ç¼–è¯‘ç»“æŸ
            echo "#endif // RCT_NEW_ARCH_ENABLED" >> "$UNIMPL_MM"
          fi

      - name: åº”ç”¨æ‰€æœ‰å¿…è¦è¡¥ä¸
        id: apply-patches
        run: |
          echo "=== åº”ç”¨æ‰€æœ‰å¿…è¦è¡¥ä¸ ==="
          START_TIME=$(date +%s)
          
          # Patch 1: FuseboxTracer.cpp for C++ compatibility
          if [ -f "node_modules/react-native/ReactCommon/reactperflogger/fusebox/FuseboxTracer.cpp" ]; then
            echo "1ï¸âƒ£ ä¿®è¡¥ FuseboxTracer.cpp..."
            perl -pi -e "s/!trackIdMap\.contains\(([^)]+)\)/trackIdMap.find(\$1) == trackIdMap.end()/g" node_modules/react-native/ReactCommon/reactperflogger/fusebox/FuseboxTracer.cpp
            perl -pi -e "s/trackIdMap\.contains\(([^)]+)\)/trackIdMap.find(\$1) != trackIdMap.end()/g" node_modules/react-native/ReactCommon/reactperflogger/fusebox/FuseboxTracer.cpp
          else
            echo "âš ï¸ è­¦å‘Š: æ‰¾ä¸åˆ° FuseboxTracer.cpp æ–‡ä»¶ï¼Œè·³è¿‡ä¿®è¡¥"
          fi

          # Patch 2: react-native-screens constexpr bug
          if [ -f "node_modules/react-native-screens/ios/RNSScreenStackHeaderConfig.mm" ]; then
            echo "2ï¸âƒ£ ä¿®è¡¥ RNSScreenStackHeaderConfig.mm..."
            sed -i '' 's/static constexpr auto DEFAULT_TITLE_FONT_SIZE = @17;/static NSNumber* const DEFAULT_TITLE_FONT_SIZE = @17;/g' node_modules/react-native-screens/ios/RNSScreenStackHeaderConfig.mm
            sed -i '' 's/static constexpr auto DEFAULT_TITLE_LARGE_FONT_SIZE = @34;/static NSNumber* const DEFAULT_TITLE_LARGE_FONT_SIZE = @34;/g' node_modules/react-native-screens/ios/RNSScreenStackHeaderConfig.mm
          else
            echo "âš ï¸ è­¦å‘Š: æ‰¾ä¸åˆ° RNSScreenStackHeaderConfig.mm æ–‡ä»¶ï¼Œè·³è¿‡ä¿®è¡¥"
          fi
          
          # Patch 3: RNSScreenStackHeaderConfig.h nullable warning
          if [ -f "node_modules/react-native-screens/ios/RNSScreenStackHeaderConfig.h" ]; then
            echo "3ï¸âƒ£ ä¿®è¡¥ RNSScreenStackHeaderConfig.h æ·»åŠ  _Nullable/_Nonnull ä¿®é¥°ç¬¦..."
            sed -i '' 's/@property (nonatomic, weak) RNSScreenView \*screenView;/@property (nonatomic, weak) RNSScreenView * _Nullable screenView;/g' node_modules/react-native-screens/ios/RNSScreenStackHeaderConfig.h
          else
            echo "âš ï¸ è­¦å‘Š: æ‰¾ä¸åˆ° RNSScreenStackHeaderConfig.h æ–‡ä»¶ï¼Œè·³è¿‡ä¿®è¡¥"
          fi
          
          # Patch 4: ä¿®å¤React/UIView.hé”™è¯¯å¯¼å…¥é—®é¢˜
          SVG_VIEW_PATH="node_modules/react-native-svg/apple/Elements/RNSVGSvgView.h"
          if [ -f "$SVG_VIEW_PATH" ]; then
            echo "4ï¸âƒ£ ä¿®è¡¥ RNSVGSvgView.h å¯¼å…¥é”™è¯¯..."
            # åˆ›å»ºå¤‡ä»½
            cp "$SVG_VIEW_PATH" "${SVG_VIEW_PATH}.bak"
            # æ›¿æ¢é”™è¯¯çš„å¯¼å…¥
            sed -i '' 's/#import <React\/UIView.h>/#import <UIKit\/UIView.h>/g' "$SVG_VIEW_PATH"
            echo "âœ… å·²ä¿®å¤ $SVG_VIEW_PATH"
            
            # åœ¨Reactç›®å½•ä¸‹åˆ›å»ºUIView.hå ä½ç¬¦
            mkdir -p "node_modules/react-native/React"
            echo "// å ä½ç¬¦: è¿™ä¸ªæ–‡ä»¶åº”è¯¥ä»UIKitå¯¼å…¥, è€Œä¸æ˜¯ä»React" > "node_modules/react-native/React/UIView.h"
            echo "#import <UIKit/UIView.h>" >> "node_modules/react-native/React/UIView.h"
            echo "âœ… å·²åˆ›å»ºReact/UIView.hå ä½ç¬¦"
          else
            echo "âš ï¸ è­¦å‘Š: æ‰¾ä¸åˆ° RNSVGSvgView.h æ–‡ä»¶ï¼Œè·³è¿‡ä¿®è¡¥"
          fi
          
          # é€’å½’æœç´¢å’Œä¿®å¤æ‰€æœ‰é”™è¯¯å¯¼å…¥
          echo "5ï¸âƒ£ å…¨å±€æœç´¢å’Œä¿®å¤React/UIView.hé”™è¯¯å¯¼å…¥..."
          find ./node_modules/react-native-svg -type f -name "*.h" -o -name "*.m" -o -name "*.mm" | xargs grep -l "React/UIView.h" 2>/dev/null | while read file; do
            echo "ä¿®å¤æ–‡ä»¶: $file"
            sed -i '' 's/#import <React\/UIView.h>/#import <UIKit\/UIView.h>/g' "$file"
          done
          echo "âœ… å®Œæˆå…¨å±€ä¿®å¤"
          
          # Patch 5: è‡ªåŠ¨ä¿®å¤æ‰€æœ‰ä½¿ç”¨Fabricçš„MMæ–‡ä»¶
          echo "6ï¸âƒ£ æ‰¹é‡ä¿®å¤æ‰€æœ‰ä½¿ç”¨Fabricçš„SVGæ–‡ä»¶..."
          
          # æŸ¥æ‰¾æ‰€æœ‰åŒ…å«facebook::reactçš„æ–‡ä»¶
          FABRIC_FILES=$(find ./node_modules/react-native-svg -name "*.mm" | xargs grep -l "facebook::react" 2>/dev/null || true)
          
          for file in $FABRIC_FILES; do
            echo "ä¿®å¤Fabricæ–‡ä»¶: $file"
            
            # è·å–å¯¹åº”çš„å¤´æ–‡ä»¶è·¯å¾„
            header_file=${file/.mm/.h}
            
            # å¦‚æœå¤´æ–‡ä»¶å­˜åœ¨ï¼Œè¯»å–ç±»å
            if [ -f "$header_file" ]; then
              # æå–ç±»å - å°è¯•ä»@interfaceè¡Œè·å–
              CLASS_NAME=$(grep -m 1 "@interface" "$header_file" | awk '{print $2}')
              echo "æ£€æµ‹åˆ°ç±»å: $CLASS_NAME"
              
              # å¤‡ä»½åŸå§‹æ–‡ä»¶
              cp "$file" "${file}.original"
              
              # åˆ›å»ºç®€åŒ–å®ç°
              {
                echo '/**'
                echo ' * Copyright (c) 2015-present, Horcrux.'
                echo ' * All rights reserved.'
                echo ' *'
                echo ' * This source code is licensed under the MIT-style license found in the'
                echo ' * LICENSE file in the root directory of this source tree.'
                echo ' */'
                echo ''
                echo "#import \"${CLASS_NAME}.h\""
                echo '#import <React/RCTLog.h>'
                echo ''
                echo "@implementation ${CLASS_NAME}"
                echo ''
                echo '// ç®€åŒ–å®ç°ä»¥é¿å…Fabricæ¶æ„é”™è¯¯'
                echo "@end"
              } > "$file"
              
              echo "âœ… å·²ç®€åŒ–æ–‡ä»¶: $file"
            else
              echo "âš ï¸ æ‰¾ä¸åˆ°å¯¹åº”çš„å¤´æ–‡ä»¶: $header_fileï¼Œæ— æ³•è‡ªåŠ¨ä¿®å¤"
            fi
          done
          
          # ç‰¹æ®Šå¤„ç†RNSVGTextPath.mmæ–‡ä»¶
          TEXT_PATH_FILE="node_modules/react-native-svg/apple/Text/RNSVGTextPath.mm"
          if [ -f "$TEXT_PATH_FILE" ]; then
            echo "7ï¸âƒ£ ç‰¹æ®Šå¤„ç†RNSVGTextPath.mmæ–‡ä»¶..."
            cp "$TEXT_PATH_FILE" "${TEXT_PATH_FILE}.bak"
            
            # åˆ›å»ºæœ€å°åŒ–å®ç°
            echo '/**' > "$TEXT_PATH_FILE"
            echo ' * Copyright (c) 2015-present, Horcrux.' >> "$TEXT_PATH_FILE"
            echo ' * All rights reserved.' >> "$TEXT_PATH_FILE"
            echo ' *' >> "$TEXT_PATH_FILE"
            echo ' * This source code is licensed under the MIT-style license found in the' >> "$TEXT_PATH_FILE"
            echo ' * LICENSE file in the root directory of this source tree.' >> "$TEXT_PATH_FILE"
            echo ' */' >> "$TEXT_PATH_FILE"
            echo '' >> "$TEXT_PATH_FILE"
            echo '#import "RNSVGTextPath.h"' >> "$TEXT_PATH_FILE"
            echo '#import <React/RCTLog.h>' >> "$TEXT_PATH_FILE"
            echo '' >> "$TEXT_PATH_FILE"
            echo '@implementation RNSVGTextPath' >> "$TEXT_PATH_FILE"
            echo '' >> "$TEXT_PATH_FILE"
            echo '- (void)setHref:(NSString *)href' >> "$TEXT_PATH_FILE"
            echo '{' >> "$TEXT_PATH_FILE"
            echo '    if ([href isEqualToString:_href]) {' >> "$TEXT_PATH_FILE"
            echo '        return;' >> "$TEXT_PATH_FILE"
            echo '    }' >> "$TEXT_PATH_FILE"
            echo '    [self invalidate];' >> "$TEXT_PATH_FILE"
            echo '    _href = href;' >> "$TEXT_PATH_FILE"
            echo '}' >> "$TEXT_PATH_FILE"
            echo '' >> "$TEXT_PATH_FILE"
            echo '- (void)setStartOffset:(RNSVGLength *)startOffset' >> "$TEXT_PATH_FILE"
            echo '{' >> "$TEXT_PATH_FILE"
            echo '    if ([startOffset isEqualTo:_startOffset]) {' >> "$TEXT_PATH_FILE"
            echo '        return;' >> "$TEXT_PATH_FILE"
            echo '    }' >> "$TEXT_PATH_FILE"
            echo '    [self invalidate];' >> "$TEXT_PATH_FILE"
            echo '    _startOffset = startOffset;' >> "$TEXT_PATH_FILE"
            echo '}' >> "$TEXT_PATH_FILE"
            echo '' >> "$TEXT_PATH_FILE"
            echo '- (void)setMethod:(enum RNSVGTextPathMethod)method' >> "$TEXT_PATH_FILE"
            echo '{' >> "$TEXT_PATH_FILE"
            echo '    if (method == _method) {' >> "$TEXT_PATH_FILE"
            echo '        return;' >> "$TEXT_PATH_FILE"
            echo '    }' >> "$TEXT_PATH_FILE"
            echo '    [self invalidate];' >> "$TEXT_PATH_FILE"
            echo '    _method = method;' >> "$TEXT_PATH_FILE"
            echo '}' >> "$TEXT_PATH_FILE"
            echo '' >> "$TEXT_PATH_FILE"
            echo '- (void)setMidLine:(enum RNSVGTextPathMidLine)midLine' >> "$TEXT_PATH_FILE"
            echo '{' >> "$TEXT_PATH_FILE"
            echo '    if (midLine == _midLine) {' >> "$TEXT_PATH_FILE"
            echo '        return;' >> "$TEXT_PATH_FILE"
            echo '    }' >> "$TEXT_PATH_FILE"
            echo '    [self invalidate];' >> "$TEXT_PATH_FILE"
            echo '    _midLine = midLine;' >> "$TEXT_PATH_FILE"
            echo '}' >> "$TEXT_PATH_FILE"
            echo '' >> "$TEXT_PATH_FILE"
            echo '- (void)setSpacing:(enum RNSVGTextPathSpacing)spacing' >> "$TEXT_PATH_FILE"
            echo '{' >> "$TEXT_PATH_FILE"
            echo '    if (spacing == _spacing) {' >> "$TEXT_PATH_FILE"
            echo '        return;' >> "$TEXT_PATH_FILE"
            echo '    }' >> "$TEXT_PATH_FILE"
            echo '    [self invalidate];' >> "$TEXT_PATH_FILE"
            echo '    _spacing = spacing;' >> "$TEXT_PATH_FILE"
            echo '}' >> "$TEXT_PATH_FILE"
            echo '' >> "$TEXT_PATH_FILE"
            echo '- (void)setSide:(enum RNSVGTextPathSide)side' >> "$TEXT_PATH_FILE"
            echo '{' >> "$TEXT_PATH_FILE"
            echo '    if (side == _side) {' >> "$TEXT_PATH_FILE"
            echo '        return;' >> "$TEXT_PATH_FILE"
            echo '    }' >> "$TEXT_PATH_FILE"
            echo '    [self invalidate];' >> "$TEXT_PATH_FILE"
            echo '    _side = side;' >> "$TEXT_PATH_FILE"
            echo '}' >> "$TEXT_PATH_FILE"
            echo '' >> "$TEXT_PATH_FILE"
            echo '@end' >> "$TEXT_PATH_FILE"
            
            echo "âœ… å·²ä¿®å¤ RNSVGTextPath.mm"
          else
            echo "âš ï¸ æ‰¾ä¸åˆ° RNSVGTextPath.mm æ–‡ä»¶"
          fi
          
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo "âœ… æ‰€æœ‰è¡¥ä¸åº”ç”¨å®Œæˆï¼Œè€—æ—¶: ${DURATION}ç§’"

      - name: ä¿®å¤react-native-svgé‡å¤æ–‡ä»¶é—®é¢˜
        run: |
          echo "=== è·³è¿‡react-native-svgç›¸å…³ä¿®å¤ ==="
          
          # æ£€æŸ¥æ˜¯å¦å·²ç»å®Œå…¨ç§»é™¤react-native-svg
          if [ ! -d "./node_modules/react-native-svg" ]; then
            echo "âœ… react-native-svgå·²å®Œå…¨ç§»é™¤ï¼Œæ— éœ€ä¿®å¤"
          else
            echo "âš ï¸ è­¦å‘Š: node_modulesä¸­ä»å­˜åœ¨react-native-svgç›®å½•ï¼Œå¯èƒ½æ˜¯å…¶ä»–ä¾èµ–é¡¹å¼•å…¥çš„"
          fi
          
      - name: å½»åº•ä¿®å¤RNSVGUseæ–‡ä»¶
        run: |
          echo "=== è·³è¿‡react-native-svgç›¸å…³ä¿®å¤ ==="
          echo "å·²ä½¿ç”¨react-native-vector-iconsæ›¿ä»£SVGï¼Œæ— éœ€ä¿®å¤SVGæ–‡ä»¶"
          
      - name: ä¿®å¤react-native-svgå¯¼å…¥é—®é¢˜
        run: |
          echo "=== è·³è¿‡react-native-svgç›¸å…³ä¿®å¤ ==="
          
          # åˆ›å»ºReactç¼ºå¤±å¤´æ–‡ä»¶å ä½ç¬¦
          echo "åˆ›å»ºReactç¼ºå¤±çš„å¤´æ–‡ä»¶å ä½ç¬¦..."
          mkdir -p "./node_modules/react-native/React"
          echo "// Empty placeholder for missing header" > "./node_modules/react-native/React/RCTConversions.h"
          echo "// Empty placeholder for missing header" > "./node_modules/react-native/React/RCTFabricComponentsPlugins.h"
          
          echo "âœ… å·²åˆ›å»ºReactç¼ºå¤±å¤´æ–‡ä»¶å ä½ç¬¦"
          
      - name: å…¨å±€ä¿®å¤React Nativeå¤´æ–‡ä»¶é—®é¢˜
        run: |
          echo "=== å…¨å±€ä¿®å¤React Nativeå¤´æ–‡ä»¶é—®é¢˜ ==="
          
          # åªä¿ç•™åˆ›å»ºå¿…è¦çš„å¤´æ–‡ä»¶ç›®å½•
          mkdir -p "./node_modules/react/renderer/components"
          echo "// Empty placeholder" > "./node_modules/react/renderer/components/ComponentDescriptors.h"
          
          echo "âœ… å·²åˆ›å»ºReact Rendererç»„ä»¶å ä½ç¬¦"

      - name: ä¿®å¤react-native-svgç»„ä»¶é—®é¢˜
        run: |
          echo "=== è·³è¿‡react-native-svgç»„ä»¶é—®é¢˜ä¿®å¤ ==="
          echo "å·²ä½¿ç”¨react-native-vector-iconsæ›¿ä»£SVGï¼Œæ— éœ€ä¿®å¤SVGç»„ä»¶é—®é¢˜"
          
      - name: é¢„å¤„ç†å®‰å…¨åŒºåŸŸä¸Šä¸‹æ–‡åº“ä»¥é¿å…é‡å¤å¤´æ–‡ä»¶
        run: |
          echo "=== é¢„å¤„ç†å®‰å…¨åŒºåŸŸä¸Šä¸‹æ–‡åº“ä»¥é¿å…é‡å¤å¤´æ–‡ä»¶ ==="
          
          # ç›´æ¥åˆ é™¤ç”Ÿæˆçš„ç›®å½•ï¼Œå› ä¸ºè¿™äº›æ–‡ä»¶ä¼šå¯¼è‡´å†²çª
          echo "åˆ é™¤ç”Ÿæˆçš„å¤´æ–‡ä»¶..."
          rm -rf "./node_modules/react-native-safe-area-context/ios/build"
          
          # å¦‚æœéœ€è¦ï¼Œåˆ›å»ºä¸€ä¸ªç©ºçš„å ä½ç¬¦ç›®å½•ç»“æ„ï¼Œé˜²æ­¢æ„å»ºè¿‡ç¨‹ä¸­çš„è·¯å¾„é”™è¯¯
          mkdir -p "./node_modules/react-native-safe-area-context/ios/build/generated/ios/safeareacontext"
          
          echo "âœ… å®Œæˆé¢„å¤„ç†"

      - name: ä¿®å¤react-native-svgå¼•ç”¨è·¯å¾„é—®é¢˜
        run: |
          echo "=== ä¿®å¤React Nativeå¼•ç”¨è·¯å¾„é—®é¢˜ ==="
          node fix-import-paths.js
          
      - name: ä¿®å¤React Coreé‡å¤å¤´æ–‡ä»¶é—®é¢˜
        run: |
          echo "=== ä¿®å¤React Coreé‡å¤å¤´æ–‡ä»¶é—®é¢˜ ==="
          node fix-duplicate-headers.js
          
      # æ·»åŠ ä¿®å¤æ‰€æœ‰Fabricç»„ä»¶çš„æ­¥éª¤
      - name: ä¿®å¤æ‰€æœ‰React Native Fabricç»„ä»¶
        run: |
          echo "=== ä¿®å¤æ‰€æœ‰React Native Fabricç»„ä»¶ ==="
          node fix-all-fabric-components.js

      - name: ä¿®å¤Podfile
        run: |
          echo "=== ä¿®å¤Podfileä»¥ç¡®ä¿ç¦ç”¨æ–°æ¶æ„ ==="
          cd ios
          
          if [ -f "Podfile" ]; then
            cp Podfile Podfile.bak
            
            # ç¡®ä¿ç¯å¢ƒå˜é‡åœ¨Podfileä¸­æ­£ç¡®è®¾ç½®
            grep -q "ENV\['RCT_NEW_ARCH_ENABLED'\]" Podfile && \
              sed -i '' 's/ENV\[\x27RCT_NEW_ARCH_ENABLED\x27\][[:space:]]*=[[:space:]]*\x271\x27/ENV[\x27RCT_NEW_ARCH_ENABLED\x27] = \x270\x27/g' Podfile || \
              echo "# å¼ºåˆ¶ç¦ç”¨æ–°æ¶æ„" >> Podfile
            
            # å†™å…¥ç¦ç”¨Fabricçš„é…ç½®
            echo "# ç¡®ä¿ç¦ç”¨æ–°æ¶æ„" >> Podfile
            echo "ENV[\"RCT_NEW_ARCH_ENABLED\"] = \"0\"" >> Podfile
            echo "ENV[\"USE_FABRIC\"] = \"0\"" >> Podfile
            echo "ENV[\"USE_HERMES\"] = \"0\"" >> Podfile
            echo "" >> Podfile
            echo "# ç¦ç”¨æ‰€æœ‰Fabricç›¸å…³è®¾ç½®" >> Podfile
            echo "\$RCT_NEW_ARCH_ENABLED = false" >> Podfile
            echo "\$fabric_enabled = false" >> Podfile
            echo "\$USE_FABRIC = false" >> Podfile
            echo "\$USE_HERMES = false" >> Podfile
            echo "\$RCT_FABRIC_ENABLED = false" >> Podfile
            
            # åˆ›å»ºrubyå‡½æ•°ä¿®å¤é‡å¤æ–‡ä»¶é—®é¢˜
            echo "" >> Podfile
            echo "# ä¿®å¤é‡å¤å¤´æ–‡ä»¶çš„å‡½æ•°" >> Podfile
            echo "def fix_duplicate_headers(installer)" >> Podfile
            echo "  puts \"æ­£åœ¨ä¿®å¤é‡å¤å¤´æ–‡ä»¶...\"" >> Podfile
            echo "  installer.pods_project.targets.each do |target|" >> Podfile
            echo "    if target.name == 'RNSVG'" >> Podfile
            echo "      puts \"ä¿®å¤RNSVGå¤´æ–‡ä»¶...\"" >> Podfile
            echo "      # æ‰¾åˆ°æ‰€æœ‰çš„å¤åˆ¶å¤´æ–‡ä»¶é˜¶æ®µ" >> Podfile
            echo "      target.build_phases.each do |phase|" >> Podfile
            echo "        if phase.is_a?(Xcodeproj::Project::Object::PBXHeadersBuildPhase)" >> Podfile
            echo "          puts \"å¤„ç†å¤´æ–‡ä»¶é˜¶æ®µ...\"" >> Podfile
            echo "          # æŸ¥æ‰¾é‡å¤çš„RNSVGFabricConversions.hæ–‡ä»¶å¼•ç”¨" >> Podfile
            echo "          fabric_files = phase.files.select do |file|" >> Podfile
            echo "            file.display_name == 'RNSVGFabricConversions.h'" >> Podfile
            echo "          end" >> Podfile
            echo "          if fabric_files.count > 1" >> Podfile
            echo "            puts \"æ‰¾åˆ°#{fabric_files.count}ä¸ªé‡å¤çš„RNSVGFabricConversions.hå¼•ç”¨ï¼Œä¿ç•™ç¬¬ä¸€ä¸ªï¼Œç§»é™¤å…¶ä½™çš„...\"" >> Podfile
            echo "            # ä¿ç•™ç¬¬ä¸€ä¸ªï¼Œåˆ é™¤å…¶ä»–" >> Podfile
            echo "            fabric_files[1..-1].each do |file|" >> Podfile
            echo "              file.remove_from_project" >> Podfile
            echo "            end" >> Podfile
            echo "            puts \"å·²è§£å†³é‡å¤æ–‡ä»¶é—®é¢˜\"" >> Podfile
            echo "          end" >> Podfile
            echo "        end" >> Podfile
            echo "      end" >> Podfile
            echo "    end" >> Podfile
            echo "  end" >> Podfile
            echo "end" >> Podfile
            
            # æ£€æŸ¥æ˜¯å¦å·²æœ‰post_installå¹¶ä¿®æ”¹ï¼Œè€Œä¸æ˜¯æ·»åŠ æ–°çš„
            if grep -q "post_install" Podfile; then
              echo "Podfileå·²åŒ…å«post_installï¼Œå°†ä¿®æ”¹è€Œä¸æ˜¯æ·»åŠ æ–°çš„..."
              
              # åœ¨post_installå—ä¸­æŸ¥æ‰¾ä»£ç æ’å…¥ä½ç½®
              if grep -q "installer.pods_project.targets.each" Podfile; then
                # å·²ç»æœ‰targetå¾ªç¯ï¼Œåœ¨åˆé€‚çš„ä½ç½®æ·»åŠ æˆ‘ä»¬çš„ä»£ç 
                SEARCH_PATTERN="post_install do |installer|"
                INSERT_AFTER_LINE=$(grep -n "$SEARCH_PATTERN" Podfile | head -1 | cut -d: -f1)
                
                if [ ! -z "$INSERT_AFTER_LINE" ]; then
                  # åˆ›å»ºä¸´æ—¶æ–‡ä»¶
                  cp Podfile Podfile.tmp
                  HEAD_PART=$(head -n $INSERT_AFTER_LINE Podfile.tmp)
                  TAIL_PART=$(tail -n +$(($INSERT_AFTER_LINE + 1)) Podfile.tmp)
                  
                  # å†™å…¥åˆå¹¶åçš„æ–‡ä»¶
                  echo "$HEAD_PART" > Podfile
                  echo "  # ä¿®å¤é‡å¤å¤´æ–‡ä»¶" >> Podfile
                  echo "  fix_duplicate_headers(installer)" >> Podfile
                  echo "$TAIL_PART" >> Podfile
                  
                  echo "âœ… æˆåŠŸåœ¨post_installå¼€å¤´æ·»åŠ ä¿®å¤é‡å¤å¤´æ–‡ä»¶çš„ä»£ç "
                fi
              else
                # æ‰¾ä¸åˆ°æ’å…¥ç‚¹ï¼Œä½¿ç”¨sedæ›¿æ¢
                sed -i '' '/post_install do |installer|/a\
                \ \ # ä¿®å¤é‡å¤å¤´æ–‡ä»¶\
                \ \ fix_duplicate_headers(installer)
                ' Podfile
              fi
            else
              # æ²¡æœ‰ç°æœ‰çš„post_installï¼Œå¯ä»¥å®‰å…¨åœ°æ·»åŠ ä¸€ä¸ªæ–°çš„
              echo "" >> Podfile
              echo "# æ·»åŠ è‡ªå®šä¹‰å¤´æ–‡ä»¶æœç´¢è·¯å¾„" >> Podfile
              echo "post_install do |installer|" >> Podfile
              echo "  # ä¿®å¤é‡å¤å¤´æ–‡ä»¶" >> Podfile
              echo "  fix_duplicate_headers(installer)" >> Podfile
              echo "  installer.pods_project.targets.each do |target|" >> Podfile
              echo "    if target.name == 'react-native-safe-area-context'" >> Podfile
              echo "      target.build_configurations.each do |config|" >> Podfile
              echo "        config.build_settings['HEADER_SEARCH_PATHS'] ||= ''" >> Podfile
              echo "        config.build_settings['HEADER_SEARCH_PATHS'] << ' \$(PODS_ROOT)/../../node_modules/react-native-safe-area-context/ios'" >> Podfile
              echo "        config.build_settings['GCC_PREPROCESSOR_DEFINITIONS'] ||= '$(inherited)'" >> Podfile
              echo "        config.build_settings['GCC_PREPROCESSOR_DEFINITIONS'] << ' RCT_NEW_ARCH_ENABLED=0'" >> Podfile
              echo "      end" >> Podfile
              echo "    end" >> Podfile
              echo "  end" >> Podfile
              echo "end" >> Podfile
            fi
            
            echo "Podfileå·²ä¿®å¤ï¼Œå†…å®¹:"
            cat Podfile | tail -n 20
          else
            echo "âš ï¸ è­¦å‘Š: æ‰¾ä¸åˆ°Podfile"
          fi

      - name: å®‰è£…CocoaPodsä¾èµ–
        run: |
          cd ios
          echo "=== å¼€å§‹å®‰è£…CocoaPodsä¾èµ– ==="
          START_TIME=$(date +%s)
          
          # é…ç½®gitä»¥å¤„ç†å¤§ä»“åº“
          git config --global http.lowSpeedLimit 0
          git config --global http.lowSpeedTime 999999
          
          # ç¡®ä¿ç¯å¢ƒå˜é‡è®¾ç½®æ­£ç¡®
          export RCT_NEW_ARCH_ENABLED=0
          export USE_HERMES=0
          
          # å°è¯•3æ¬¡å®‰è£…pods
          for i in {1..3}; do
            echo "=== å°è¯• $i: å®‰è£… pods... ==="
            pod install --verbose && break
            echo "=== å°è¯• $i å¤±è´¥ï¼Œé‡è¯•ä¸­... ==="
            if [ $i -eq 3 ]; then
              echo "âŒ å®‰è£…CocoaPodså¤±è´¥ï¼Œå·²è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°"
              exit 1
            fi
            sleep 10
          done
          
          # æ£€æŸ¥å®‰è£…ç»“æœ
          if [ ! -d "Pods" ]; then
            echo "âŒ é”™è¯¯: Podsç›®å½•ä¸å­˜åœ¨ï¼Œå®‰è£…å¤±è´¥"
            exit 1
          else
            END_TIME=$(date +%s)
            DURATION=$((END_TIME - START_TIME))
            echo "âœ… CocoaPodsä¾èµ–å®‰è£…æˆåŠŸï¼Œè€—æ—¶: ${DURATION}ç§’"
            ls -la
          fi

      - name: ä¿®å¤react-native-safe-area-contexté‡å¤å¤´æ–‡ä»¶é—®é¢˜
        run: |
          echo "=== ä¿®å¤react-native-safe-area-contexté‡å¤å¤´æ–‡ä»¶é—®é¢˜ ==="
          cd ios
          
          # ä»Podsé¡¹ç›®æ¸…ç†é‡å¤çš„å¤´æ–‡ä»¶å¼•ç”¨
          if [ -d "Pods" ]; then
            echo "åˆ é™¤ç”Ÿæˆçš„å¤´æ–‡ä»¶..."
            rm -rf "../node_modules/react-native-safe-area-context/ios/build/generated"
            
            # å¦‚æœbuildç›®å½•ä¸ºç©ºï¼Œå®Œå…¨åˆ é™¤å®ƒä»¥é˜²æ­¢æ··æ·†
            if [ -z "$(ls -A ../node_modules/react-native-safe-area-context/ios/build 2>/dev/null)" ]; then
              rm -rf "../node_modules/react-native-safe-area-context/ios/build"
            fi
            
            echo "âœ… å®Œæˆæ¸…ç†ç”Ÿæˆçš„å¤´æ–‡ä»¶"
          else
            echo "âš ï¸ è­¦å‘Š: Podsç›®å½•ä¸å­˜åœ¨ï¼Œè¯·å…ˆè¿è¡Œpod install"
          fi
          
          cd ..

      - name: æ·±åº¦ä¿®å¤react-native-safe-area-context
        run: |
          echo "=== æ·±åº¦ä¿®å¤react-native-safe-area-context Fabricä¾èµ–é—®é¢˜ ==="
          SAFE_AREA_DIR="node_modules/react-native-safe-area-context"
          
          if [ -d "$SAFE_AREA_DIR" ]; then
            # å®Œå…¨é‡å†™RNCSafeAreaContext.mmï¼Œç§»é™¤æ‰€æœ‰Fabricä»£ç 
            MM_FILE="$SAFE_AREA_DIR/ios/RNCSafeAreaContext.mm"
            if [ -f "$MM_FILE" ]; then
              cp "$MM_FILE" "${MM_FILE}.original"
              
              # ä½¿ç”¨echoå‘½ä»¤åˆ›å»ºç®€åŒ–ç‰ˆæœ¬
              echo '#import "RNCSafeAreaContext.h"' > "$MM_FILE"
              echo '#import <React/RCTBridge.h>' >> "$MM_FILE"
              echo '#import <React/RCTUIManager.h>' >> "$MM_FILE"
              echo '' >> "$MM_FILE"
              echo '@implementation RNCSafeAreaContext' >> "$MM_FILE"
              echo '' >> "$MM_FILE"
              echo 'RCT_EXPORT_MODULE()' >> "$MM_FILE"
              echo '' >> "$MM_FILE"
              echo '+ (BOOL)requiresMainQueueSetup' >> "$MM_FILE"
              echo '{' >> "$MM_FILE"
              echo '  return YES;' >> "$MM_FILE"
              echo '}' >> "$MM_FILE"
              echo '' >> "$MM_FILE"
              echo '@end' >> "$MM_FILE"
              
              echo "âœ… å·²é‡å†™ RNCSafeAreaContext.mm ä¸ºç®€åŒ–ç‰ˆæœ¬"
            fi
            
            # ä¿®æ”¹RNCSafeAreaContext.hæ–‡ä»¶
            H_FILE="$SAFE_AREA_DIR/ios/RNCSafeAreaContext.h"
            if [ -f "$H_FILE" ]; then
              cp "$H_FILE" "${H_FILE}.original"
              
              # ä½¿ç”¨echoå‘½ä»¤åˆ›å»ºç®€åŒ–ç‰ˆæœ¬
              echo '#import <React/RCTBridgeModule.h>' > "$H_FILE"
              echo '#import <React/RCTEventEmitter.h>' >> "$H_FILE"
              echo '' >> "$H_FILE"
              echo '@interface RNCSafeAreaContext : RCTEventEmitter <RCTBridgeModule>' >> "$H_FILE"
              echo '@end' >> "$H_FILE"
              
              echo "âœ… å·²é‡å†™ RNCSafeAreaContext.h ä¸ºç®€åŒ–ç‰ˆæœ¬"
            fi
          else
            echo "âš ï¸ æ‰¾ä¸åˆ° react-native-safe-area-context ç›®å½•"
          fi

      - name: é¢„æ„å»ºReact Native Bundle
        if: ${{ inputs.skip_bundle != 'true' }}
        run: |
          echo "=== é¢„æ„å»ºReact Native Bundle ä»¥ç¡®ä¿æ‰“åŒ…è„šæœ¬æ­£ç¡® ==="
          START_TIME=$(date +%s)
          mkdir -p ios/bundle
          npx react-native bundle \
            --entry-file index.js \
            --platform ios \
            --dev false \
            --bundle-output ios/bundle/main.jsbundle \
            --assets-dest ios/bundle
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo "âœ… Bundleæ„å»ºå®Œæˆï¼Œè€—æ—¶: ${DURATION}ç§’"

      - name: ä¿®å¤React Nativeæ‰“åŒ…è„šæœ¬
        run: |
          echo "=== ä¿®å¤React Nativeæ‰“åŒ…è„šæœ¬ ==="
          SCRIPT_PATH="node_modules/react-native/scripts/react-native-xcode.sh"
          if [ -f "$SCRIPT_PATH" ]; then
            # å¤‡ä»½åŸå§‹æ–‡ä»¶
            cp "$SCRIPT_PATH" "${SCRIPT_PATH}.bak"
            
            # ä¿®æ”¹è„šæœ¬å¢åŠ æ›´å¤šæ—¥å¿—è¾“å‡ºå’Œé”™è¯¯å¤„ç†
            sed -i '' 's/set -e/set -ex/' "$SCRIPT_PATH"
            
            # å°è¯•ä¿®å¤NODE_BINARYé—®é¢˜
            sed -i '' 's/export NODE_BINARY=.*/export NODE_BINARY=node/' "$SCRIPT_PATH"
            
            echo "âœ… React Nativeæ‰“åŒ…è„šæœ¬å·²ä¿®æ”¹"
          else
            echo "âš ï¸ è­¦å‘Š: æ‰¾ä¸åˆ°React Nativeæ‰“åŒ…è„šæœ¬ï¼Œè·³è¿‡ä¿®å¤"
          fi
          
          # åˆ›å»º.xcode.env.localæ–‡ä»¶ä»¥ç¡®ä¿æ­£ç¡®çš„Nodeè·¯å¾„
          echo "export NODE_BINARY=$(which node)" > ios/.xcode.env.local
          # ç¡®ä¿æ­£ç¡®è®¾ç½®ç¯å¢ƒå˜é‡
          echo "export RCT_NEW_ARCH_ENABLED=0" >> ios/.xcode.env.local
          echo "export USE_FABRIC=0" >> ios/.xcode.env.local
          echo "export USE_HERMES=0" >> ios/.xcode.env.local
          echo "åˆ›å»ºäº†.xcode.env.localæ–‡ä»¶: $(cat ios/.xcode.env.local)"
          
                    # ä½¿ç”¨ç»Ÿä¸€è„šæœ¬åˆ›å»ºæ‰€æœ‰å…³é”®çš„React Nativeæ–‡ä»¶ï¼ˆç¬¬äºŒå¤„ï¼Œæ›¿æ¢é‡å¤é€»è¾‘ï¼‰
          echo "ğŸ”§ è¿è¡Œç»Ÿä¸€è„šæœ¬åˆ›å»ºå…³é”®çš„React Nativeæ–‡ä»¶..."
          node fix-rct-viewcomponent-unified.js
          echo "âœ… ç»Ÿä¸€è„šæœ¬æ‰§è¡Œå®Œæˆï¼Œæ‰€æœ‰å…³é”®æ–‡ä»¶å·²åˆ›å»º"
          
          # ä¿®å¤åŸå§‹ React Native Fabric æ–‡ä»¶çš„ç¼–è¯‘é—®é¢˜
          echo "ğŸ”§ ä¿®å¤åŸå§‹ Fabric æ–‡ä»¶çš„ç¼–è¯‘é—®é¢˜..."
          node fix-fabric-original-files.js
          echo "âœ… åŸå§‹ Fabric æ–‡ä»¶ä¿®å¤å®Œæˆ"
          
          # ç¡®ä¿RCTViewFinder.mmæ–‡ä»¶å­˜åœ¨
          FINDER_FILE="node_modules/react-native/React/Fabric/Utils/RCTViewFinder.mm"
          mkdir -p "$(dirname "$FINDER_FILE")"
          echo '/* æ‰‹åŠ¨ä¿®å¤ä»¥è§£å†³ç¼–è¯‘é”™è¯¯ */' > "$FINDER_FILE"
          echo '#import <React/RCTDefines.h>' >> "$FINDER_FILE"
          echo '' >> "$FINDER_FILE"
          echo '#ifndef RCT_NEW_ARCH_ENABLED' >> "$FINDER_FILE"
          echo '#define RCT_NEW_ARCH_ENABLED 0' >> "$FINDER_FILE"
          echo '#endif' >> "$FINDER_FILE"
          echo '' >> "$FINDER_FILE" 
          echo '#if RCT_NEW_ARCH_ENABLED' >> "$FINDER_FILE"
          echo '/* Copyright notice */' >> "$FINDER_FILE"
          echo '#import "RCTViewFinder.h"' >> "$FINDER_FILE"
          echo '#import <React/RCTViewComponentView.h>' >> "$FINDER_FILE"
          echo '' >> "$FINDER_FILE"
          echo '@implementation RCTViewFinder' >> "$FINDER_FILE"
          echo '' >> "$FINDER_FILE"
          echo '+ (UIView *)findView:(UIView *)root withNativeId:(NSString *)nativeId' >> "$FINDER_FILE"
          echo '{' >> "$FINDER_FILE"
          echo '  if (!nativeId) {' >> "$FINDER_FILE"
          echo '    return nil;' >> "$FINDER_FILE"
          echo '  }' >> "$FINDER_FILE"
          echo '' >> "$FINDER_FILE"
          echo '  if ([root isKindOfClass:[RCTViewComponentView class]] &&' >> "$FINDER_FILE"
          echo '      [nativeId isEqualToString:((RCTViewComponentView *)root).nativeId]) {' >> "$FINDER_FILE"
          echo '    return root;' >> "$FINDER_FILE"
          echo '  }' >> "$FINDER_FILE"
          echo '' >> "$FINDER_FILE"
          echo '  for (UIView *subview in root.subviews) {' >> "$FINDER_FILE"
          echo '    UIView *result = [RCTViewFinder findView:subview withNativeId:nativeId];' >> "$FINDER_FILE"
          echo '    if (result) {' >> "$FINDER_FILE"
          echo '      return result;' >> "$FINDER_FILE"
          echo '    }' >> "$FINDER_FILE"
          echo '  }' >> "$FINDER_FILE"
          echo '' >> "$FINDER_FILE"
          echo '  return nil;' >> "$FINDER_FILE"
          echo '}' >> "$FINDER_FILE"
          echo '' >> "$FINDER_FILE"
          echo '@end' >> "$FINDER_FILE"
          echo '' >> "$FINDER_FILE"
          echo '#else' >> "$FINDER_FILE"
          echo '#import <UIKit/UIKit.h>' >> "$FINDER_FILE"
          echo '#import <React/RCTViewComponentView.h>' >> "$FINDER_FILE"
          echo '' >> "$FINDER_FILE"
          echo 'UIView *RCTFindComponentViewWithName(UIView *view, NSString *nativeId) {' >> "$FINDER_FILE"
          echo '  if (!nativeId) {' >> "$FINDER_FILE"
          echo '    return nil;' >> "$FINDER_FILE"
          echo '  }' >> "$FINDER_FILE"
          echo '' >> "$FINDER_FILE"
          echo '  if ([view isKindOfClass:[RCTViewComponentView class]]) {' >> "$FINDER_FILE"
          echo '    if ([nativeId isEqualToString:((RCTViewComponentView *)view).nativeId]) {' >> "$FINDER_FILE"
          echo '      return view;' >> "$FINDER_FILE"
          echo '    }' >> "$FINDER_FILE"
          echo '  }' >> "$FINDER_FILE"
          echo '' >> "$FINDER_FILE"
          echo '  for (UIView *subview in view.subviews) {' >> "$FINDER_FILE"
          echo '    UIView *result = RCTFindComponentViewWithName(subview, nativeId);' >> "$FINDER_FILE"
          echo '    if (result != nil) {' >> "$FINDER_FILE"
          echo '      return result;' >> "$FINDER_FILE"
          echo '    }' >> "$FINDER_FILE"
          echo '  }' >> "$FINDER_FILE"
          echo '' >> "$FINDER_FILE"
          echo '  return nil;' >> "$FINDER_FILE"
          echo '}' >> "$FINDER_FILE"
          echo '#endif' >> "$FINDER_FILE"
          
          # ä¿®å¤RCTTextComponentView
          echo "=== ä¿®å¤RCTTextComponentView ==="
          TEXT_COMP_DIR="node_modules/react-native/React/Fabric/Mounting/ComponentViews/Text"
          mkdir -p "$TEXT_COMP_DIR"
          
          # ä¿®æ”¹æˆ–åˆ›å»ºRCTTextComponentView.h
          TEXT_HEADER="$TEXT_COMP_DIR/RCTTextComponentView.h"
          echo '#import <React/RCTDefines.h>' > "$TEXT_HEADER"
          echo '#import <React/RCTViewComponentView.h>' >> "$TEXT_HEADER"
          echo '#import <UIKit/UIKit.h>' >> "$TEXT_HEADER"
          echo '' >> "$TEXT_HEADER"
          echo '#ifndef RCT_NEW_ARCH_ENABLED' >> "$TEXT_HEADER"
          echo '#define RCT_NEW_ARCH_ENABLED 0' >> "$TEXT_HEADER"
          echo '#endif' >> "$TEXT_HEADER"
          echo '' >> "$TEXT_HEADER"
          echo '#if RCT_NEW_ARCH_ENABLED' >> "$TEXT_HEADER"
          echo '// åŸå§‹æ–°æ¶æ„å®ç°' >> "$TEXT_HEADER"
          echo '@interface RCTTextComponentView : RCTViewComponentView' >> "$TEXT_HEADER"
          echo '// åŸæœ‰æ–¹æ³•' >> "$TEXT_HEADER"
          echo '@end' >> "$TEXT_HEADER"
          echo '#else' >> "$TEXT_HEADER"
          echo '// æ—§æ¶æ„å…¼å®¹å®ç°' >> "$TEXT_HEADER"
          echo '@interface RCTTextComponentView : UIView' >> "$TEXT_HEADER"
          echo '@property (nonatomic, copy, nullable) NSString *text;' >> "$TEXT_HEADER"
          echo '@end' >> "$TEXT_HEADER"
          echo '#endif' >> "$TEXT_HEADER"
          
          # ä¿®æ”¹æˆ–åˆ›å»ºRCTTextComponentView.mm
          TEXT_IMPL="$TEXT_COMP_DIR/RCTTextComponentView.mm"
          echo '#import "RCTTextComponentView.h"' > "$TEXT_IMPL"
          echo '#import <React/RCTDefines.h>' >> "$TEXT_IMPL"
          echo '' >> "$TEXT_IMPL"
          echo '#ifndef RCT_NEW_ARCH_ENABLED' >> "$TEXT_IMPL"
          echo '#define RCT_NEW_ARCH_ENABLED 0' >> "$TEXT_IMPL"
          echo '#endif' >> "$TEXT_IMPL"
          echo '' >> "$TEXT_IMPL"
          echo '#if RCT_NEW_ARCH_ENABLED' >> "$TEXT_IMPL"
          echo '// åŸå§‹æ–°æ¶æ„å®ç°' >> "$TEXT_IMPL"
          echo '@implementation RCTTextComponentView' >> "$TEXT_IMPL"
          echo '' >> "$TEXT_IMPL"
          echo '- (instancetype)initWithFrame:(CGRect)frame {' >> "$TEXT_IMPL"
          echo '  if (self = [super initWithFrame:frame]) {' >> "$TEXT_IMPL"
          echo '    // åˆå§‹åŒ–ä»£ç ' >> "$TEXT_IMPL"
          echo '  }' >> "$TEXT_IMPL"
          echo '  return self;' >> "$TEXT_IMPL"
          echo '}' >> "$TEXT_IMPL"
          echo '' >> "$TEXT_IMPL"
          echo '- (void)updateProps:(id)props oldProps:(id)oldProps {' >> "$TEXT_IMPL"
          echo '  [super updateProps:props oldProps:oldProps];' >> "$TEXT_IMPL"
          echo '  // æ›´æ–°é€»è¾‘' >> "$TEXT_IMPL"
          echo '}' >> "$TEXT_IMPL"
          echo '' >> "$TEXT_IMPL"
          echo '@end' >> "$TEXT_IMPL"
          echo '' >> "$TEXT_IMPL"
          echo '#else' >> "$TEXT_IMPL"
          echo '// æ—§æ¶æ„å…¼å®¹å®ç°' >> "$TEXT_IMPL"
          echo '@implementation RCTTextComponentView {' >> "$TEXT_IMPL"
          echo '  UILabel *_label;' >> "$TEXT_IMPL"
          echo '  NSString *_text;' >> "$TEXT_IMPL"
          echo '}' >> "$TEXT_IMPL"
          echo '' >> "$TEXT_IMPL"
          echo '- (instancetype)initWithFrame:(CGRect)frame {' >> "$TEXT_IMPL"
          echo '  if (self = [super initWithFrame:frame]) {' >> "$TEXT_IMPL"
          echo '    _label = [[UILabel alloc] initWithFrame:self.bounds];' >> "$TEXT_IMPL"
          echo '    _label.autoresizingMask = UIViewAutoresizingFlexibleWidth | UIViewAutoresizingFlexibleHeight;' >> "$TEXT_IMPL"
          echo '    [self addSubview:_label];' >> "$TEXT_IMPL"
          echo '  }' >> "$TEXT_IMPL"
          echo '  return self;' >> "$TEXT_IMPL"
          echo '}' >> "$TEXT_IMPL"
          echo '' >> "$TEXT_IMPL"
          echo '- (NSString *)text {' >> "$TEXT_IMPL"
          echo '  return _text;' >> "$TEXT_IMPL"
          echo '}' >> "$TEXT_IMPL"
          echo '' >> "$TEXT_IMPL"
          echo '- (void)setText:(NSString *)text {' >> "$TEXT_IMPL"
          echo '  _text = [text copy];' >> "$TEXT_IMPL"
          echo '  _label.text = _text;' >> "$TEXT_IMPL"
          echo '}' >> "$TEXT_IMPL"
          echo '' >> "$TEXT_IMPL"
          echo '@end' >> "$TEXT_IMPL"
          echo '#endif' >> "$TEXT_IMPL"
          
          # ä¿®å¤å…¶ä»–å¸¸è§ç»„ä»¶çš„å¤´æ–‡ä»¶ï¼Œç¡®ä¿å®ƒä»¬å¯ä»¥æ‰¾åˆ°RCTViewComponentView
          echo "=== è·³è¿‡æ‰‹åŠ¨å¤åˆ¶ï¼ˆç»Ÿä¸€è„šæœ¬å·²å®Œæˆå¤åˆ¶ï¼‰ ==="
          # æ³¨é‡Šï¼šç»Ÿä¸€è„šæœ¬å·²ç»å®Œæˆäº†æ‰€æœ‰å¿…è¦çš„æ–‡ä»¶å¤åˆ¶ï¼Œæ— éœ€é‡å¤æ“ä½œ
          
          # æœç´¢å¹¶ä¿®å¤å…¶ä»–ç»„ä»¶
          echo "=== æŸ¥æ‰¾å’Œä¿®å¤å…¶ä»–ä¾èµ–RCTViewComponentViewçš„ç»„ä»¶ ==="
          find "node_modules/react-native/React/Fabric/Mounting/ComponentViews" -name "*.h" -o -name "*.mm" | while read file; do
            if grep -q "RCTViewComponentView" "$file"; then
              echo "ä¿®å¤æ–‡ä»¶: $file"
              # å¤‡ä»½åŸå§‹æ–‡ä»¶
              cp "$file" "${file}.bak"
              # æ·»åŠ å¿…è¦çš„å¯¼å…¥
              if [[ "$file" == *.h ]]; then
                # å¯¹äºå¤´æ–‡ä»¶ï¼Œåœ¨æ–‡ä»¶é¡¶éƒ¨æ·»åŠ å¯¼å…¥
                sed -i '' '1i\
                #import <React/RCTDefines.h>\
                #import <React/RCTViewComponentView.h>\
                ' "$file"
                # ä½¿ç”¨æ¡ä»¶ç¼–è¯‘åŒ…è£…ç±»å®šä¹‰
                sed -i '' 's/@interface \(.*\) : RCTViewComponentView/#if RCT_NEW_ARCH_ENABLED\
                @interface \1 : RCTViewComponentView/g' "$file"
                # åœ¨æ–‡ä»¶æœ«å°¾æ·»åŠ #endif
                echo "#endif" >> "$file"
              elif [[ "$file" == *.mm ]]; then
                # å¯¹äºå®ç°æ–‡ä»¶ï¼Œåœ¨æ–‡ä»¶é¡¶éƒ¨æ·»åŠ å®šä¹‰
                sed -i '' '1i\
                #import <React/RCTDefines.h>\
                \
                #ifndef RCT_NEW_ARCH_ENABLED\
                #define RCT_NEW_ARCH_ENABLED 0\
                #endif\
                \
                ' "$file"
              fi
            fi
          done
          
          echo "å·²ä¿®å¤æ‰€æœ‰ç»„ä»¶æ–‡ä»¶"

      - name: åˆ—å‡º workspace é‡Œçš„ scheme
        run: |
          cd ios
          echo "=== å·¥ä½œç©ºé—´å’Œæ–¹æ¡ˆä¿¡æ¯ ==="
          xcodebuild -list -workspace HomeServiceChat.xcworkspace

      - name: æ‰§è¡Œæ¸…ç†æ„å»º
        run: |
          cd ios
          echo "=== æ‰§è¡Œæ¸…ç†æ„å»º ==="
          xcodebuild clean \
            -workspace HomeServiceChat.xcworkspace \
            -scheme HomeServiceChat \
            -configuration Release

      - name: å½’æ¡£ Release åŒ…ï¼ˆæ— ç­¾åï¼‰
        id: archive
        run: |
          cd ios
          echo "=== å¼€å§‹å½’æ¡£è¿‡ç¨‹ ==="
          START_TIME=$(date +%s)
          
          # è®¾ç½®å½’æ¡£è·¯å¾„
          ARCHIVE_PATH="$PWD/build/HomeServiceChat.xcarchive"
          
          # ç¡®ä¿ç¦ç”¨æ–°æ¶æ„çš„ç¯å¢ƒå˜é‡
          export RCT_NEW_ARCH_ENABLED=0
          
          # æ‰§è¡Œå½’æ¡£
          xcodebuild -workspace HomeServiceChat.xcworkspace \
            -scheme HomeServiceChat \
            -configuration Release \
            -sdk iphoneos \
            -destination 'generic/platform=iOS' \
            -archivePath "$ARCHIVE_PATH" \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            ENABLE_BITCODE=NO \
            GCC_OPTIMIZATION_LEVEL=0 \
            ONLY_ACTIVE_ARCH=NO \
            CLANG_CXX_LANGUAGE_STANDARD="c++20" \
            OTHER_CFLAGS="-DNS_BLOCK_ASSERTIONS=1" \
            RCT_NEW_ARCH_ENABLED=0 \
            RCT_FABRIC_ENABLED=0 \
            USE_FABRIC=0 \
            FABRIC_ENABLED=NO \
            GCC_PREPROCESSOR_DEFINITIONS="RCT_NEW_ARCH_ENABLED=0" \
            archive \
            -verbose \
            -showBuildTimingSummary \
            | tee build.log || { echo "âŒ æ„å»ºå¤±è´¥"; cat build.log | tail -n 300; exit 1; }
          
          # æ£€æŸ¥å½’æ¡£ç»“æœ
          if [ -d "$ARCHIVE_PATH" ]; then
            END_TIME=$(date +%s)
            DURATION=$((END_TIME - START_TIME))
            echo "âœ… å½’æ¡£æˆåŠŸ: ç”Ÿæˆäº† HomeServiceChat.xcarchiveï¼Œè€—æ—¶: ${DURATION}ç§’"
            ls -la $ARCHIVE_PATH
            echo "archive_duration=$DURATION" >> $GITHUB_OUTPUT
          else
            echo "âŒ å½’æ¡£å¤±è´¥: æ‰¾ä¸åˆ° HomeServiceChat.xcarchive"
            echo "=== æ„å»ºæ—¥å¿—æ‘˜è¦ï¼ˆæœ«å°¾ï¼‰ ==="
            if [ -f build.log ]; then
              tail -n 300 build.log
            fi
            exit 1
          fi

      - name: éªŒè¯æ„å»ºç»“æœ
        if: success()
        run: |
          cd ios
          ARCHIVE_PATH="$PWD/build/HomeServiceChat.xcarchive"
          echo "=== éªŒè¯å½’æ¡£æ–‡ä»¶ ==="
          if [ -d "$ARCHIVE_PATH" ]; then
            echo "å½’æ¡£æ–‡ä»¶å­˜åœ¨ï¼Œå¤§å°:"
            du -sh "$ARCHIVE_PATH"
            echo "å½’æ¡£å†…å®¹:"
            ls -la "$ARCHIVE_PATH"
          else
            echo "âŒ é”™è¯¯: æ‰¾ä¸åˆ°å½’æ¡£æ–‡ä»¶"
            exit 1
          fi

      - name: ä¿å­˜æ„å»ºæ—¥å¿—
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-${{ env.APP_VERSION }}-${{ env.BUILD_NUMBER }}
          path: |
            ios/build.log
            ios/Pods/Pods.xcodeproj
            ios/HomeServiceChat.xcworkspace

      - name: å¯¼å‡º ipa åŒ…
        id: export-ipa
        if: success()
        run: |
          cd ios
          echo "=== å¼€å§‹å¯¼å‡ºIPA ==="
          START_TIME=$(date +%s)
          
          # å½’æ¡£è·¯å¾„å’Œå¯¼å‡ºè·¯å¾„
          ARCHIVE_PATH="$PWD/build/HomeServiceChat.xcarchive"
          EXPORT_PATH="$PWD/build/ipa"
          
          # ç¡®è®¤å¯¼å‡ºé…ç½®æ–‡ä»¶å­˜åœ¨
          if [ ! -f "exportOptions.plist" ]; then
            echo "âŒ é”™è¯¯: æ‰¾ä¸åˆ°å¯¼å‡ºé…ç½®æ–‡ä»¶ exportOptions.plist"
            exit 1
          fi
          
          # ç¡®ä¿å¯¼å‡ºç›®å½•å­˜åœ¨
          mkdir -p "$EXPORT_PATH"
          
          # å¯¼å‡ºIPA
          xcodebuild -exportArchive \
            -archivePath "$ARCHIVE_PATH" \
            -exportOptionsPlist exportOptions.plist \
            -exportPath "$EXPORT_PATH" \
            -verbose \
            | tee export.log || { echo "âŒ å¯¼å‡ºå¤±è´¥"; cat export.log; exit 1; }
          
          # æ£€æŸ¥å¯¼å‡ºç»“æœ
          if [ -d "$EXPORT_PATH" ] && [ "$(ls -A $EXPORT_PATH)" ]; then
            END_TIME=$(date +%s)
            DURATION=$((END_TIME - START_TIME))
            echo "âœ… IPAå¯¼å‡ºæˆåŠŸï¼Œè€—æ—¶: ${DURATION}ç§’"
            echo "export_duration=$DURATION" >> $GITHUB_OUTPUT
            
            # é‡å‘½åIPAæ–‡ä»¶
            cd "$EXPORT_PATH"
            IPA_FILE=$(ls *.ipa 2>/dev/null || echo "")
            if [ -n "$IPA_FILE" ]; then
              NEW_IPA_NAME="HomeServiceChat-${{ env.APP_VERSION }}-${{ env.BUILD_NUMBER }}.ipa"
              mv "$IPA_FILE" "$NEW_IPA_NAME"
              echo "âœ… IPAå·²é‡å‘½åä¸º: $NEW_IPA_NAME"
              echo "IPAå¤§å°: $(du -h $NEW_IPA_NAME | cut -f1)"
            else
              echo "âš ï¸ æœªæ‰¾åˆ°IPAæ–‡ä»¶ï¼Œæ— æ³•é‡å‘½å"
            fi
            
            ls -la
          else
            echo "âŒ å¯¼å‡ºå¤±è´¥: IPAç›®å½•ä¸ºç©º"
            if [ -f export.log ]; then
              echo "=== å¯¼å‡ºæ—¥å¿— ==="
              cat export.log
            fi
            exit 1
          fi

      - name: æ”¶é›†è¯Šæ–­ä¿¡æ¯
        if: failure()
        run: |
          echo "=== æ”¶é›†è¯Šæ–­ä¿¡æ¯ ==="
          echo "ç›®å½•ç»“æ„:"
          ls -la
          echo "iOSç›®å½•:"
          ls -la ios/
          echo "æ„å»ºç›®å½•:"
          ls -la ios/build/ || echo "æ„å»ºç›®å½•ä¸å­˜åœ¨"
          echo "æœ€è¿‘é”™è¯¯æ—¥å¿—:"
          find ios -name "*.log" -type f -mtime -1 -exec ls -la {} \; -exec echo "=== {} ===" \; -exec tail -n 50 {} \;

      - name: ä¸Šä¼  ipa åŒ…
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: HomeServiceChat-${{ env.APP_VERSION }}-${{ env.BUILD_NUMBER }}
          path: ios/build/ipa/*.ipa
          
      - name: æ„å»ºæ‘˜è¦
        if: always()
        run: |
          echo "=== æ„å»ºæ‘˜è¦ ==="
          echo "æ„å»ºç‰ˆæœ¬: ${{ env.APP_VERSION }} (æ„å»ºå·: ${{ env.BUILD_NUMBER }})"
          echo "æ„å»ºçŠ¶æ€: ${{ job.status }}"
          if [ "${{ job.status }}" == "success" ]; then
            echo "å½’æ¡£è€—æ—¶: ${{ steps.archive.outputs.archive_duration || 'N/A' }} ç§’"
            echo "å¯¼å‡ºè€—æ—¶: ${{ steps.export-ipa.outputs.export_duration || 'N/A' }} ç§’"
            echo "IPAè·¯å¾„: ios/build/ipa/HomeServiceChat-${{ env.APP_VERSION }}-${{ env.BUILD_NUMBER }}.ipa"
          fi
